name: Auto PR Format

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-description:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for better diff analysis

      - name: Generate PR Description
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR TITLE: ${{ github.event.pull_request.title }}
            CURRENT PR BODY: ${{ github.event.pull_request.body }}
            BASE BRANCH: ${{ github.event.pull_request.base.ref }}

            Analyze the changes in this PR and generate a comprehensive description and conventional commit-style title.

            Steps:
            1. Use `git diff origin/${{ github.event.pull_request.base.ref }}...HEAD` to see all changes
            2. Read relevant files to understand the context of changes
            3. Generate a PR title following Conventional Commits format:
               - Format: `<type>[optional scope]: <description>`
               - Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert
               - Example: `feat(api): add user authentication endpoint`
               - Use `!` after type/scope for breaking changes: `feat(api)!: change response format`
            4. Generate a well-structured PR description with:
               - A brief summary (1-2 sentences)
               - Key changes (bullet points)
               - Any breaking changes or migration notes if applicable
            5. Use `gh pr edit ${{ github.event.pull_request.number }} --title "YOUR_TITLE" --body "YOUR_DESCRIPTION"` to update the PR

            Guidelines:
            - If the PR title already follows conventional commit format, keep it unless it's inaccurate
            - If the PR already has a meaningful description, enhance it rather than replace it entirely
            - Keep the title concise (under 72 characters) and the description informative
            - Use markdown formatting for readability
          claude_args: |
            --allowedTools "Bash(git diff:*),Bash(git log:*),Bash(gh pr edit:*),Read,Glob,Grep"
