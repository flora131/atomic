name: Publish

on:
    push:
        branches:
            - "release/**"
    release:
        types: [published]
    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to release (e.g., v0.1.0)"
                required: true
                type: string

permissions:
    contents: write
    id-token: write

concurrency:
    group: publish-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        name: Build Binaries
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun ci

            - name: Install all platform-specific opentui native bindings
              run: |
                  # Platform packages have os/cpu fields that block install on foreign platforms.
                  # Download and extract tarballs directly to bypass platform checks.
                  OPENTUI_VERSION=$(node -p "require('./package.json').dependencies['@opentui/core'].replace(/[\^~]/, '')")
                  for platform in darwin-x64 darwin-arm64 linux-arm64 win32-x64 win32-arm64; do
                    pkg="@opentui/core-${platform}"
                    dest="node_modules/@opentui/core-${platform}"
                    if [ ! -d "$dest" ]; then
                      mkdir -p "$dest"
                      npm pack "${pkg}@${OPENTUI_VERSION}" --pack-destination /tmp 2>/dev/null
                      tar -xzf "/tmp/opentui-core-${platform}-${OPENTUI_VERSION}.tgz" -C "$dest" --strip-components=1
                    fi
                  done

            - name: Run tests
              run: bun test

            - name: Run typecheck
              run: bun run typecheck

            - name: Build binaries for all platforms
              run: |
                  mkdir -p dist

                  # Linux x64
                  bun build src/cli.ts --compile --minify --target=bun-linux-x64 --outfile dist/atomic-linux-x64

                  # Linux arm64
                  bun build src/cli.ts --compile --minify --target=bun-linux-arm64 --outfile dist/atomic-linux-arm64

                  # macOS x64
                  bun build src/cli.ts --compile --minify --target=bun-darwin-x64 --outfile dist/atomic-darwin-x64

                  # macOS arm64 (Apple Silicon)
                  bun build src/cli.ts --compile --minify --target=bun-darwin-arm64 --outfile dist/atomic-darwin-arm64

            - name: Create config archives
              run: |
                  # Create a staging directory for config files
                  mkdir -p config-staging

                  # Copy config directories (same as package.json "files" for binary distribution)
                  cp -r .claude config-staging/
                  cp -r .opencode config-staging/
                  mkdir -p config-staging/.github
                  cp -r .github/skills config-staging/.github/
                  cp -r .github/agents config-staging/.github/

                  # Remove node_modules from .opencode if present
                  rm -rf config-staging/.opencode/node_modules

                  # Create tarball for Unix systems (preserves permissions)
                  tar -czvf dist/atomic-config.tar.gz -C config-staging .

                  # Create zip for Windows
                  cd config-staging && zip -r ../dist/atomic-config.zip . && cd ..

            - name: Upload artifacts
              uses: actions/upload-artifact@v6
              with:
                  name: binaries
                  path: dist/

    build-windows:
        name: Build Windows Binary
        runs-on: windows-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun ci

            - name: Build Windows binary natively
              run: |
                  mkdir dist
                  bun build src/cli.ts --compile --minify --outfile dist/atomic-windows-x64.exe

            - name: Upload Windows artifact
              uses: actions/upload-artifact@v6
              with:
                  name: binaries-windows
                  path: dist/

    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: [build, build-windows]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Download artifacts
              uses: actions/download-artifact@v7
              with:
                  name: binaries
                  path: dist/

            - name: Download Windows artifacts
              uses: actions/download-artifact@v7
              with:
                  name: binaries-windows
                  path: dist/

            - name: Get version from package.json
              id: version
              run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

            - name: Create checksums
              run: |
                  cd dist
                  sha256sum * > checksums.txt

            - name: Delete existing release assets
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  TAG="v${{ steps.version.outputs.version }}"
                  gh release view "$TAG" --json assets --jq '.assets[].name' 2>/dev/null | while read -r name; do
                    gh release delete-asset "$TAG" "$name" --yes 2>/dev/null || true
                  done
              continue-on-error: true

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  name: v${{ steps.version.outputs.version }}
                  draft: false
                  prerelease: false
                  generate_release_notes: true
                  files: |
                      dist/atomic-linux-x64
                      dist/atomic-linux-arm64
                      dist/atomic-darwin-x64
                      dist/atomic-darwin-arm64
                      dist/atomic-windows-x64.exe
                      dist/atomic-config.tar.gz
                      dist/atomic-config.zip
                      dist/checksums.txt

    publish-npm:
        name: Publish to npm
        runs-on: ubuntu-latest
        needs: build
        if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
        permissions:
            contents: read
            id-token: write # Required for OIDC provenance

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun ci

            - name: Setup Node.js for npm publish
              uses: actions/setup-node@v6
              with:
                  node-version: "lts/*"
                  registry-url: "https://registry.npmjs.org"

            - name: Publish to npm with provenance
              run: npm publish --provenance --access public
