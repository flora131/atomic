# Directory Structure - Model Config Loading

## Overview

This document maps the directory structure and file organization for the model configuration loading system.

## Root-Level Structure

```
atomic/
├── src/
│   ├── models/              # Model configuration system
│   ├── graph/               # Graph workflow engine (uses models)
│   ├── sdk/                 # Agent SDK clients
│   ├── ui/                  # UI components
│   ├── util/                # Utility modules (lazy loader)
│   └── ...
├── scripts/
│   └── generate-models-snapshot.ts   # Build-time snapshot generator
├── tests/
│   └── models/              # Model system tests
├── research/                # Documentation and specs
└── package.json
```

## Model Configuration Directory (`src/models/`)

```
src/models/
├── models-dev.ts            # Data access layer, schemas, lazy loader
├── model-transform.ts       # Format transformation layer
├── model-operations.ts      # Unified operations interface
├── models-snapshot.ts       # Bundled offline fallback data
├── index.ts                 # Public exports
└── __tests__/
    ├── model-operations.test.ts
    └── model-transform.test.ts
```

### File Purposes

#### `models-dev.ts` (258 lines)
- **Primary responsibility:** Data access and schema definitions
- **Exports:**
  - `ModelsDev` namespace with Zod schemas
  - `CACHE_PATH` constant
  - `REFRESH_INTERVAL` constant
  - `url()` function
  - `startModelsDevRefresh()` function
- **Key types:** `Database`, `Provider`, `Model`, `Cost`, `Limit`, `Modalities`
- **Key functions:** `get()`, `refresh()`, `listModels()`, `getModel()`, `getProvider()`

#### `model-transform.ts` (112 lines)
- **Primary responsibility:** Transform models.dev format to internal format
- **Exports:**
  - `Model` interface (internal representation)
  - `fromModelsDevModel()` function
  - `fromModelsDevProvider()` function
- **Transformations:**
  - `id` → computed as `providerID/modelID`
  - `tool_call` → `toolCall`
  - `cache_read` → `cacheRead`
  - `cache_write` → `cacheWrite`
  - Default `status` to 'active'

#### `model-operations.ts` (154 lines)
- **Primary responsibility:** Unified interface for model operations
- **Exports:**
  - `UnifiedModelOperations` class
  - `CLAUDE_ALIASES` constant
  - `AgentType` type
  - `SetModelResult` interface
  - `ModelOperations` interface
- **Key methods:**
  - `listAvailableModels()`
  - `setModel(model: string)`
  - `getCurrentModel()`
  - `resolveAlias(alias: string)`
  - `getPendingModel()`

#### `models-snapshot.ts` (12 lines)
- **Primary responsibility:** Provide bundled offline fallback
- **Generated by:** `scripts/generate-models-snapshot.ts`
- **Format:** TypeScript source file with embedded JSON
- **Current state:** Empty snapshot (needs regeneration)
- **Regenerate command:** `pnpm run update-models-snapshot`

#### `index.ts` (5 lines)
- **Primary responsibility:** Public API surface
- **Exports:** Re-exports from other modules
- Clean separation between internal and public APIs

## Related Directories

### Scripts (`scripts/`)

```
scripts/
└── generate-models-snapshot.ts    # Fetches and generates snapshot
```

**Purpose:** Build-time tooling for snapshot generation
- Fetches from `https://models.dev/api.json`
- Writes to `src/models/models-snapshot.ts`
- Includes timestamp and regeneration instructions
- Run via: `pnpm run update-models-snapshot`

### Utilities (`src/util/`)

```
src/util/
└── lazy.ts                        # Lazy initialization utility
```

**Purpose:** Generic lazy loading pattern used by ModelsDev
- Creates cached, lazily-evaluated values
- Provides `reset()` method for cache invalidation
- Used by `ModelsDev.Data` lazy loader

### Tests (`tests/models/`)

```
tests/models/
└── models-dev.test.ts             # Integration tests for ModelsDev
```

```
src/models/__tests__/
├── model-operations.test.ts       # Unit tests for UnifiedModelOperations
└── model-transform.test.ts        # Unit tests for transformation logic
```

**Test coverage:**
- Data loading (cache, snapshot, API fallbacks)
- Refresh mechanism
- Model queries (get, list, filter)
- Alias resolution
- Agent-specific behaviors
- Format validation
- Error handling

## Cache and Configuration Files

### Runtime Cache

```
~/.atomic/cache/
└── models.json                    # Runtime cache of models.dev data
```

**Location:**
- Default: `~/.atomic/cache/models.json`
- Override: `ATOMIC_MODELS_PATH` environment variable
- Auto-created on first refresh
- Format: JSON, indented for readability

**Characteristics:**
- Updated every 60 minutes by background refresh
- Persists across application restarts
- First fallback in loading chain
- User-editable (for testing/customization)

### Bundled Snapshot

```
src/models/models-snapshot.ts      # Compiled into binary
```

**Characteristics:**
- Embedded in application binary/bundle
- Zero network dependency
- Second fallback in loading chain
- Regenerated manually via script

## Build Output

### Compiled Binary

```
atomic                             # Single executable binary (Bun compile)
├── src/models/models-snapshot.ts  # Embedded at compile time
└── [other bundled source files]
```

**Note:** Cache file is NOT bundled; it's created at runtime.

## Integration Points

### Graph Workflows (`src/graph/`)

```
src/graph/
├── nodes.ts                       # Agent nodes (may use model config)
├── types.ts                       # SessionConfig with model field
└── compiled.ts                    # Graph execution engine
```

**Usage:** Graph nodes may reference model operations for dynamic model selection.

### SDK Clients (`src/sdk/`)

```
src/sdk/
├── claude-client.ts               # Uses CLAUDE_ALIASES
├── opencode-client.ts             # Uses providerID/modelID format
└── copilot-client.ts              # Requires session restart for model changes
```

**Integration:** `UnifiedModelOperations` wraps SDK-specific model setting.

### UI Commands (`src/ui/commands/`)

```
src/ui/commands/
├── agent-commands.ts              # May expose model selection
└── builtin-commands.ts            # Potential /model command
```

**Usage:** Commands may leverage model operations for user-facing model management.

## Documentation and Specs

### Research Directory (`research/`)

```
research/
├── feature-list.json              # Includes model system features
├── progress.txt                   # Implementation progress tracking
└── docs/
    └── 2026-02-03-model-params-workflow-nodes-message-queuing.md
```

### Specifications (`specs/`)

```
specs/
└── model-params-workflow-nodes-message-queuing.md
```

**Purpose:** Design documents for model configuration system.

## Configuration Files

### Package Configuration

```
package.json
├── scripts:
│   ├── update-models-snapshot     # Snapshot regeneration
│   └── generate:models            # Alias for update-models-snapshot
└── dependencies:
    └── [No direct dependency on models.dev]
```

### TypeScript Configuration

```
tsconfig.json                      # TypeScript project settings
```

**Relevant settings:**
- `"type": "module"` in package.json enables ES modules
- Zod for runtime type validation

## File Naming Conventions

### Module Files
- `kebab-case.ts` for all source files
- `__tests__/` directory for co-located tests
- `index.ts` for re-exports

### Test Files
- `*.test.ts` suffix for all test files
- Match source file names (e.g., `model-operations.test.ts`)

### Generated Files
- `models-snapshot.ts` suffix indicates generated content
- Include generation timestamp in file header comment

## Build and Distribution

### Source Distribution (npm/bun)
```
@bastani/atomic (npm package)
├── src/                           # All source files
├── .claude/                       # Agent configs
└── package.json
```

### Binary Distribution
```
atomic (single executable)
└── [all source embedded]
```

**Note:** Users get either npm package (requires Bun runtime) or compiled binary (no runtime needed).

## Environment-Specific Overrides

### Development
- Cache: `~/.atomic/cache/models.json` (user-specific)
- Snapshot: `src/models/models-snapshot.ts` (version-controlled)
- API: `https://models.dev/api.json` (default)

### Testing
- Cache: Override with `ATOMIC_MODELS_PATH=/tmp/test-cache.json`
- API: Override with `ATOMIC_MODELS_URL=http://localhost:3000/models`
- Fetch: Disable with `ATOMIC_DISABLE_MODELS_FETCH=1`

### CI/CD
- Snapshot should be pre-generated and committed
- Disable API fetching for reproducible builds
- Use mock data for integration tests

## Access Patterns

### Application Startup
```typescript
import { startModelsDevRefresh } from './models';
startModelsDevRefresh(); // Begin background refresh
```

### Query Operations
```typescript
import { ModelsDev } from './models';
const models = await ModelsDev.listModels();
const model = await ModelsDev.getModel('anthropic', 'claude-sonnet-4');
```

### Model Selection
```typescript
import { UnifiedModelOperations } from './models';
const ops = new UnifiedModelOperations('claude', sdkSetModel);
await ops.setModel('sonnet');
```

## Key Takeaways

1. **Modular Design:** Clear separation between data access, transformation, and operations
2. **Multiple Fallbacks:** File cache → snapshot → API → empty
3. **Environment Overrides:** All paths and URLs configurable via env vars
4. **Offline-First:** Snapshot embedded in binary for zero-config operation
5. **Background Updates:** Periodic refresh keeps cache fresh without blocking
6. **Test Coverage:** Comprehensive tests for all loading paths and operations
