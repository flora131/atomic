---
date: 2026-02-15
researcher: debugger agent
topic: "Sub-agent Event Flow and Race Condition Diagram"
tags: [debug, investigation, sub-agents, event-flow, diagram]
status: complete
---

# Sub-Agent Event Flow and Race Condition Diagram

## Normal Sync Task Flow (Expected)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIMELINE: Sync Task (mode: "sync" or undefined)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   TIME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¶

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ tool.start   â”‚      â”‚ subagent.start â”‚     â”‚subagent.completeâ”‚     â”‚tool.complete â”‚
   â”‚   (Task)     â”‚      â”‚                â”‚     â”‚                 â”‚     â”‚   (Task)     â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                       â”‚                     â”‚
          â–¼                      â–¼                       â–¼                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UI: Create  â”‚       â”‚ UI: Merge   â”‚        â”‚ UI: Set     â”‚       â”‚ UI: Set     â”‚
    â”‚ Agent with  â”‚       â”‚ to SDK ID   â”‚        â”‚ status =    â”‚       â”‚ result text â”‚
    â”‚ status =    â”‚       â”‚             â”‚        â”‚ "completed" â”‚       â”‚             â”‚
    â”‚ "running"   â”‚       â”‚ Keep status â”‚        â”‚             â”‚       â”‚ (No status  â”‚
    â”‚             â”‚       â”‚ "running"   â”‚        â”‚ Clear       â”‚       â”‚  change if  â”‚
    â”‚ ğŸŸ¡ GREY    â”‚       â”‚             â”‚        â”‚ currentTool â”‚       â”‚  already    â”‚
    â”‚             â”‚       â”‚ ğŸŸ¡ GREY    â”‚        â”‚             â”‚       â”‚  completed) â”‚
    â”‚             â”‚       â”‚             â”‚        â”‚ ğŸŸ¢ GREEN   â”‚       â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    src/ui/index.ts       src/ui/index.ts        src/ui/index.ts       src/ui/index.ts
    lines 507-530         lines 780-851          lines 871-905         lines 648-663

    AGENT STATE:          AGENT STATE:           AGENT STATE:          AGENT STATE:
    status: "running"     status: "running"      status: "completed"   status: "completed"
    result: undefined     result: undefined      result: undefined     result: "..." (set)
```

## Background Task Flow (RACE CONDITION)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIMELINE: Background Task (mode: "background")                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   TIME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¶

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         (much later)
   â”‚ tool.start   â”‚      â”‚ subagent.start â”‚     â”‚tool.complete â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   (Task)     â”‚      â”‚                â”‚     â”‚   (Task)     â”‚      â”‚subagent.completeâ”‚
   â”‚ mode:        â”‚      â”‚                â”‚     â”‚              â”‚      â”‚  (actual finish)â”‚
   â”‚ "background" â”‚      â”‚                â”‚     â”‚ âš ï¸  EARLY!   â”‚      â”‚                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                     â”‚                       â”‚
          â–¼                      â–¼                     â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UI: Create  â”‚       â”‚ UI: Merge   â”‚       â”‚ UI: Set     â”‚        â”‚ UI: Status  â”‚
    â”‚ Agent with  â”‚       â”‚ to SDK ID   â”‚       â”‚ status =    â”‚        â”‚ already     â”‚
    â”‚ status =    â”‚       â”‚             â”‚       â”‚ "completed" â”‚        â”‚ "completed" â”‚
    â”‚ "running"   â”‚       â”‚ Keep status â”‚       â”‚             â”‚        â”‚ (no change) â”‚
    â”‚             â”‚       â”‚ "running"   â”‚       â”‚ âŒ WRONG!   â”‚        â”‚             â”‚
    â”‚ ğŸŸ¡ GREY    â”‚       â”‚             â”‚       â”‚             â”‚        â”‚             â”‚
    â”‚             â”‚       â”‚ ğŸŸ¡ GREY    â”‚       â”‚ Set result  â”‚        â”‚ ğŸŸ¢ GREEN   â”‚
    â”‚             â”‚       â”‚             â”‚       â”‚             â”‚        â”‚             â”‚
    â”‚             â”‚       â”‚             â”‚       â”‚ ğŸŸ¢ GREEN   â”‚        â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    src/ui/index.ts       src/ui/index.ts       src/ui/index.ts        src/ui/index.ts
    lines 507-530         lines 780-851         lines 648-663          lines 871-905

    AGENT STATE:          AGENT STATE:          AGENT STATE:           AGENT STATE:
    status: "running"     status: "running"     status: "completed"    status: "completed"
    result: undefined     result: undefined     result: "..."          result: "..."
    
                                               âŒ SHOWS GREEN WHILE AGENT STILL WORKING!
                                               
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PROBLEM: The agent tree shows "N agents finished" with green      â”‚
    â”‚ status indicators, but the background task is still running!       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Expected Background Task Flow (FIX)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TIMELINE: Background Task (mode: "background") - WITH FIX                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   TIME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¶

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         (much later)
   â”‚ tool.start   â”‚      â”‚ subagent.start â”‚     â”‚tool.complete â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   (Task)     â”‚      â”‚                â”‚     â”‚   (Task)     â”‚      â”‚subagent.completeâ”‚
   â”‚ mode:        â”‚      â”‚                â”‚     â”‚              â”‚      â”‚  (actual finish)â”‚
   â”‚ "background" â”‚      â”‚                â”‚     â”‚ âœ… Checks   â”‚      â”‚                 â”‚
   â”‚              â”‚      â”‚                â”‚     â”‚    mode!     â”‚      â”‚                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                     â”‚                       â”‚
          â–¼                      â–¼                     â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ UI: Create  â”‚       â”‚ UI: Merge   â”‚       â”‚ UI: Keep    â”‚        â”‚ UI: Set     â”‚
    â”‚ Agent with  â”‚       â”‚ to SDK ID   â”‚       â”‚ status =    â”‚        â”‚ status =    â”‚
    â”‚ status =    â”‚       â”‚             â”‚       â”‚"background" â”‚        â”‚ "completed" â”‚
    â”‚"background" â”‚       â”‚ Keep status â”‚       â”‚             â”‚        â”‚             â”‚
    â”‚ OR store    â”‚       â”‚"background" â”‚       â”‚ Set result  â”‚        â”‚ Clear       â”‚
    â”‚ background: â”‚       â”‚             â”‚       â”‚             â”‚        â”‚ currentTool â”‚
    â”‚ true flag   â”‚       â”‚ ğŸŸ¡ GREY    â”‚       â”‚ ğŸŸ¡ GREY    â”‚        â”‚             â”‚
    â”‚             â”‚       â”‚             â”‚       â”‚             â”‚        â”‚ ğŸŸ¢ GREEN   â”‚
    â”‚ ğŸŸ¡ GREY    â”‚       â”‚             â”‚       â”‚ âœ… CORRECT â”‚        â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    src/ui/index.ts       src/ui/index.ts       src/ui/index.ts        src/ui/index.ts
    lines 507-530         lines 780-851         lines 648-663          lines 871-905
    (needs fix)           (no change)           (needs fix)            (works correctly)

    AGENT STATE:          AGENT STATE:          AGENT STATE:           AGENT STATE:
    status:"background"   status:"background"   status:"background"    status: "completed"
    background: true      background: true      background: true       background: true
    result: undefined     result: undefined     result: "..."          result: "..."
    
                                               âœ… STILL SHOWS GREY/RUNNING UNTIL DONE
```

## Status Indicator Color Mapping

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AgentStatus Type                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ type AgentStatus =                                                        â”‚
â”‚   | "pending"      â†’ ğŸŸ¡ GREY (muted)   - Queued, not yet started        â”‚
â”‚   | "running"      â†’ ğŸŸ¡ GREY (muted)   - Actively working               â”‚
â”‚   | "background"   â†’ ğŸŸ¡ GREY (muted)   - Running in background          â”‚
â”‚   | "completed"    â†’ ğŸŸ¢ GREEN (success) - Successfully finished          â”‚
â”‚   | "interrupted"  â†’ ğŸŸ  YELLOW (warning) - Cancelled by user             â”‚
â”‚   | "error"        â†’ ğŸ”´ RED (error)     - Failed with error              â”‚
â”‚                                                                            â”‚
â”‚ File: src/ui/components/parallel-agents-tree.tsx:26                      â”‚
â”‚ Function: getStatusIndicatorColor (lines 153-166)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tree Header Color Logic                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ const headerColor =                                                       â”‚
â”‚   runningCount > 0         â†’ accent (blue)  "Running N agents..."        â”‚
â”‚   interruptedCount > 0     â†’ warning (yellow) "N agents interrupted"     â”‚
â”‚   completedCount > 0       â†’ success (green) "N agents finished"         â”‚
â”‚   else                     â†’ muted (grey)   "N agents pending"           â”‚
â”‚                                                                            â”‚
â”‚ File: src/ui/components/parallel-agents-tree.tsx:632-639                 â”‚
â”‚                                                                            â”‚
â”‚ ISSUE: runningCount checks for "running" || "background", but if         â”‚
â”‚        all agents are marked "completed" prematurely, runningCount=0     â”‚
â”‚        and header shows green "finished" while work continues.           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Code Path Summary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File: src/ui/index.ts                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ tool.start Handler (lines 466-576)                                  â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ â€¢ Detects Task tools: data.toolName === "Task" || "task"            â”‚   â”‚
â”‚ â”‚ â€¢ Eagerly creates ParallelAgent with status: "running"              â”‚   â”‚
â”‚ â”‚ â€¢ Queues toolId in pendingTaskEntries[]                             â”‚   â”‚
â”‚ â”‚ â€¢ Maps toolId â†’ agentId in toolCallToAgentMap                       â”‚   â”‚
â”‚ â”‚ â€¢ Calls state.parallelAgentHandler() to update UI                   â”‚   â”‚
â”‚ â”‚                                                                       â”‚   â”‚
â”‚ â”‚ âŒ MISSING: Check input.mode and set status: "background" if needed â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ tool.complete Handler (lines 577-720)                               â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ â€¢ Resolves toolId from SDK correlation IDs or FIFO queue            â”‚   â”‚
â”‚ â”‚ â€¢ For Task tools: parses result text from toolResult                â”‚   â”‚
â”‚ â”‚ â€¢ Looks up agentId from toolCallToAgentMap                          â”‚   â”‚
â”‚ â”‚                                                                       â”‚   â”‚
â”‚ â”‚ âŒ PROBLEM (lines 648-663):                                         â”‚   â”‚
â”‚ â”‚   status: a.status === "running" || a.status === "pending"          â”‚   â”‚
â”‚ â”‚     ? "completed" as const   â† UNCONDITIONAL FINALIZATION           â”‚   â”‚
â”‚ â”‚     : a.status                                                       â”‚   â”‚
â”‚ â”‚                                                                       â”‚   â”‚
â”‚ â”‚ âœ… SHOULD CHECK: if (input.mode !== "background") { ... }           â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ subagent.start Handler (lines 780-868)                              â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ â€¢ Merges eager agent (toolId) with SDK agent (subagentId)           â”‚   â”‚
â”‚ â”‚ â€¢ Updates correlation mapping                                        â”‚   â”‚
â”‚ â”‚ â€¢ Preserves existing status                                          â”‚   â”‚
â”‚ â”‚ â€¢ Updates currentTool display                                        â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ subagent.complete Handler (lines 870-905)                           â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ â€¢ Sets status: "completed" or "error" based on success field        â”‚   â”‚
â”‚ â”‚ â€¢ Clears currentTool                                                 â”‚   â”‚
â”‚ â”‚ â€¢ Sets durationMs                                                    â”‚   â”‚
â”‚ â”‚ â€¢ Does NOT include result text (handled by tool.complete)           â”‚   â”‚
â”‚ â”‚                                                                       â”‚   â”‚
â”‚ â”‚ âœ… CORRECT: This handler properly sets terminal status              â”‚   â”‚
â”‚ â”‚            when the agent actually completes                         â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File: src/ui/chat.tsx                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Stream Completion Deferral (lines 3324-3332)                        â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ const hasActiveAgents = parallelAgentsRef.current.some(              â”‚   â”‚
â”‚ â”‚   (a) => a.status === "running" || a.status === "pending"            â”‚   â”‚
â”‚ â”‚ );                                                                    â”‚   â”‚
â”‚ â”‚ if (hasActiveAgents || hasRunningToolRef.current) {                  â”‚   â”‚
â”‚ â”‚   pendingCompleteRef.current = handleComplete;                       â”‚   â”‚
â”‚ â”‚   return; // Defer finalization                                      â”‚   â”‚
â”‚ â”‚ }                                                                     â”‚   â”‚
â”‚ â”‚                                                                       â”‚   â”‚
â”‚ â”‚ âœ… CORRECT: Defers stream completion while agents are active        â”‚   â”‚
â”‚ â”‚ âŒ PROBLEM: Doesn't check for "background" status                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Agent Finalization (lines 3334-3340, 4776-4779, 2671-2679)         â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ const finalizedAgents = currentAgents.map((a) =>                     â”‚   â”‚
â”‚ â”‚   a.status === "running" || a.status === "pending"                   â”‚   â”‚
â”‚ â”‚     ? { ...a, status: "completed" as const, ... }                    â”‚   â”‚
â”‚ â”‚     : a                                                               â”‚   â”‚
â”‚ â”‚ );                                                                    â”‚   â”‚
â”‚ â”‚                                                                       â”‚   â”‚
â”‚ â”‚ âŒ PROBLEM: Multiple call sites unconditionally finalize agents     â”‚   â”‚
â”‚ â”‚            during stream/message completion                          â”‚   â”‚
â”‚ â”‚ âœ… SHOULD: Skip agents with background: true flag                   â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Event Timing Analysis

### Scenario A: Fast Sync Task
```
0ms    tool.start      â†’ status: "running" (grey)
5ms    subagent.start  â†’ status: "running" (grey)
1000ms subagent.completeâ†’ status: "completed" (green) âœ… CORRECT
1001ms tool.complete    â†’ status: "completed" (green, no change)

Result: âœ… Correctly shows grey while running, green when done
```

### Scenario B: Background Task (Current Buggy Behavior)
```
0ms    tool.start      â†’ status: "running" (grey)
5ms    subagent.start  â†’ status: "running" (grey)
10ms   tool.complete   â†’ status: "completed" (green) âŒ TOO EARLY!
                         (task spawned, not completed)

[...agent still working in background for 30+ seconds...]

30000ms subagent.completeâ†’ status: "completed" (green, no change)

Result: âŒ Shows green from 10ms onward, but agent runs until 30000ms
```

### Scenario C: Background Task (Expected Fix)
```
0ms    tool.start      â†’ status: "background" (grey) âœ…
5ms    subagent.start  â†’ status: "background" (grey) âœ…
10ms   tool.complete   â†’ status: "background" (grey, preserved) âœ…
                         (checks mode field, doesn't finalize)

[...agent working in background for 30+ seconds...]

30000ms subagent.completeâ†’ status: "completed" (green) âœ… CORRECT

Result: âœ… Shows grey until agent actually completes at 30000ms
```

## Key Takeaways

1. **Race Condition Root Cause**: `tool.complete` fires before agent finishes for background tasks
2. **Premature Finalization**: Line 658 in `src/ui/index.ts` sets status without checking mode
3. **Missing Status**: `"background"` status exists in types but never assigned
4. **Multiple Sites**: Status finalization happens in 4+ places in codebase
5. **SDK-Agnostic**: Affects all three SDK backends (Claude, OpenCode, Copilot)

## Fix Checklist

- [ ] Check `input.mode` in `tool.start` handler (line ~520)
- [ ] Set initial status to `"background"` for background/async tasks
- [ ] Check `input.mode` or `agent.background` in `tool.complete` handler (line ~658)
- [ ] Don't finalize status to "completed" for background tasks
- [ ] Update deferral checks in `chat.tsx` to include `"background"` status
- [ ] Update finalization logic to skip background agents
- [ ] Add tests for background task lifecycle
- [ ] Document `"background"` status semantics
