[
  {
    "category": "refactor",
    "description": "Remove userPromptSubmitted hook configuration from hooks.json",
    "steps": [
      "Open .github/hooks/hooks.json",
      "Locate the 'userPromptSubmitted' hook block (lines 13-19)",
      "Remove the entire userPromptSubmitted section including its contents",
      "Verify JSON syntax remains valid after removal",
      "Test that hooks.json loads correctly without the removed block"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Delete the prompt-hook.sh file that is no longer needed",
    "steps": [
      "Verify .github/hooks/prompt-hook.sh exists",
      "Delete the file .github/hooks/prompt-hook.sh",
      "Verify the file has been removed from the filesystem",
      "Check that no other files reference prompt-hook.sh"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Add AGENT_INSTRUCTION_HEADERS mapping to telemetry-helper.sh",
    "steps": [
      "Open bin/telemetry-helper.sh",
      "Add a Bash associative array AGENT_INSTRUCTION_HEADERS after extract_commands() function (around line 165)",
      "Map instruction header texts to agent filenames (without .md extension)",
      "Include mappings for agents with H1 headers: explain-code, commit, create-gh-pr, research-codebase, cancel-ralph, ralph-help, ralph-loop",
      "Include mappings for agents without H1 headers using first content line: create-spec, create-feature-list, implement-feature",
      "Verify all 10 primary agent mappings are included"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement detect_copilot_agents() function in telemetry-helper.sh",
    "steps": [
      "Open bin/telemetry-helper.sh",
      "Add detect_copilot_agents() function after the AGENT_INSTRUCTION_HEADERS mapping",
      "Implement early exit if ~/.copilot/session-state directory doesn't exist",
      "Find the most recent session directory using ls -td and head -1",
      "Return early if no session directory or events.jsonl found",
      "Initialize an array to store found agents"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement Method 1: Parse user.message events for agent_instructions",
    "steps": [
      "In detect_copilot_agents(), add logic to parse events.jsonl line by line",
      "Check if event type is 'user.message'",
      "Extract transformedContent from .data.transformedContent using jq",
      "Check if transformedContent contains '<agent_instructions>'",
      "Match against AGENT_INSTRUCTION_HEADERS using a loop",
      "If agent file exists in .github/agents/, add to found_agents array",
      "Break after first match (only one agent per user.message)"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement Method 2: Parse assistant.message events for task tool calls",
    "steps": [
      "In detect_copilot_agents(), check if event type is 'assistant.message'",
      "Extract agent_type from task tool calls using jq path: .data.toolRequests[]? | select(.name == \"task\") | .arguments.agent_type",
      "For each extracted agent_type, check if .github/agents/<agent_type>.md exists",
      "If agent file exists, add to found_agents array"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement Method 3: Parse tool.execution_complete events for agent telemetry",
    "steps": [
      "In detect_copilot_agents(), check if event type is 'tool.execution_complete'",
      "Extract agent_name from .data.toolTelemetry.properties.agent_name using jq",
      "If agent file exists in .github/agents/, add to found_agents array",
      "This serves as fallback detection from tool telemetry"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Return comma-separated agent list from detect_copilot_agents()",
    "steps": [
      "After parsing all events, check if found_agents array has elements",
      "Convert array to comma-separated string using printf and tr",
      "Remove trailing comma using sed",
      "Return empty string if no agents found (Null Object Pattern)",
      "Preserve duplicates in output for frequency tracking"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Update stop-hook.sh telemetry section to use detect_copilot_agents()",
    "steps": [
      "Open .github/hooks/stop-hook.sh",
      "Locate the telemetry section (lines 210-244)",
      "Remove COMMANDS_TEMP_FILE variable declaration",
      "Remove temp file reading logic (cat, tr, sed pipeline)",
      "Remove temp file cleanup (rm -f)",
      "Replace with call to detect_copilot_agents()",
      "Update write_session_event() call to use DETECTED_AGENTS variable",
      "Update comments to reflect new agent detection approach"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Unit test: detect_copilot_agents returns empty when no session directory exists",
    "steps": [
      "Create a test that temporarily renames or mocks ~/.copilot/session-state",
      "Call detect_copilot_agents()",
      "Verify function returns empty string",
      "Restore original state"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Unit test: detect_copilot_agents returns empty when events.jsonl is missing",
    "steps": [
      "Create a mock session directory without events.jsonl",
      "Call detect_copilot_agents()",
      "Verify function returns empty string",
      "Clean up mock directory"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Unit test: detect_copilot_agents extracts agent from agent_instructions correctly",
    "steps": [
      "Create a mock events.jsonl with user.message containing <agent_instructions>",
      "Include instruction header text that matches AGENT_INSTRUCTION_HEADERS",
      "Create corresponding .github/agents/<agent>.md file if needed",
      "Call detect_copilot_agents()",
      "Verify correct agent name is returned"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Unit test: detect_copilot_agents extracts agent_type from task tool calls",
    "steps": [
      "Create a mock events.jsonl with assistant.message containing task tool call",
      "Include agent_type in .data.toolRequests[].arguments",
      "Create corresponding .github/agents/<agent>.md file if needed",
      "Call detect_copilot_agents()",
      "Verify correct agent name is returned"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Unit test: detect_copilot_agents filters to only existing agent files",
    "steps": [
      "Create a mock events.jsonl with agent references to non-existent agent files",
      "Call detect_copilot_agents()",
      "Verify function returns empty string (non-existent agents filtered out)",
      "Add a valid .github/agents/<agent>.md file and test again",
      "Verify only existing agents are returned"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Unit test: detect_copilot_agents preserves duplicates for frequency tracking",
    "steps": [
      "Create a mock events.jsonl with multiple invocations of the same agent",
      "Call detect_copilot_agents()",
      "Verify all occurrences are in output (e.g., 'explain-code,explain-code,commit')",
      "Confirm duplicates are not deduplicated"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Integration test: End-to-end with mock events.jsonl file",
    "steps": [
      "Create a comprehensive mock events.jsonl with mixed event types",
      "Include user.message with agent_instructions",
      "Include assistant.message with task tool calls",
      "Include tool.execution_complete with agent telemetry",
      "Set up required .github/agents/*.md files",
      "Call detect_copilot_agents()",
      "Verify all detected agents are returned in correct order"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Integration test: Verify hooks.json loads correctly after modification",
    "steps": [
      "Run jq validation on modified .github/hooks/hooks.json",
      "Verify JSON is syntactically valid",
      "Verify sessionStart and sessionEnd hooks are still present",
      "Verify userPromptSubmitted hook is absent"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Manual test: Invoke agent via dropdown and verify detection",
    "steps": [
      "Start a GitHub Copilot session",
      "Select an agent from the dropdown menu (e.g., explain-code)",
      "Submit a prompt using the selected agent",
      "End the session",
      "Check telemetry-events.jsonl for the agent_session event",
      "Verify the commands array contains 'explain-code'"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Manual test: Invoke agent via CLI --agent flag and verify detection",
    "steps": [
      "Run: copilot --agent=explain-code --prompt 'Explain this code'",
      "Wait for session to complete",
      "Check telemetry-events.jsonl for the agent_session event",
      "Verify the commands array contains 'explain-code'"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Manual test: Invoke agent via natural language and verify detection",
    "steps": [
      "Start a GitHub Copilot session",
      "Type a prompt like 'use explain-code to analyze the main function'",
      "Wait for assistant response with task tool call",
      "End the session",
      "Check telemetry-events.jsonl for the agent_session event",
      "Verify the commands array contains 'explain-code'"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Manual test: Verify no telemetry written when telemetry disabled",
    "steps": [
      "Disable telemetry in settings",
      "Start a GitHub Copilot session",
      "Invoke one or more agents",
      "End the session",
      "Verify no new events were written to telemetry-events.jsonl",
      "Re-enable telemetry after test"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Verify unchanged files: Claude Code telemetry unaffected",
    "steps": [
      "Verify .claude/hooks/telemetry-stop.sh has not been modified",
      "Run Claude Code session and verify telemetry still works correctly",
      "Check telemetry-events.jsonl for claude agent_session events"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Verify unchanged files: OpenCode telemetry unaffected",
    "steps": [
      "Verify .opencode/plugin/telemetry.ts has not been modified",
      "Run OpenCode session and verify telemetry still works correctly",
      "Check telemetry-events.jsonl for opencode agent_session events"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Verify unchanged files: TypeScript telemetry code unaffected",
    "steps": [
      "Verify src/utils/telemetry/*.ts files have not been modified",
      "Run existing telemetry tests: pnpm test telemetry",
      "Verify all tests pass"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Verify unchanged files: Agent definition files unaffected",
    "steps": [
      "Verify .github/agents/*.md files have not been modified",
      "Check git status for any changes to agent files",
      "Confirm agent files are read-only for this refactoring"
    ],
    "passes": true
  }
]
