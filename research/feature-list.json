[
  {
    "category": "refactor",
    "description": "Create CodingAgentClient interface with common session management operations",
    "steps": [
      "Create src/sdk/types.ts file",
      "Define SessionConfig interface with model, sessionId, systemPrompt, tools, mcpServers, permissionMode, maxBudgetUsd, maxTurns",
      "Define Session interface with id, send, stream, summarize, getContextUsage, destroy methods",
      "Define AgentMessage type with type, content, metadata fields",
      "Define EventType union type for session.start, session.idle, session.error, message.delta, message.complete, tool.start, tool.complete, subagent.start, subagent.complete",
      "Define AgentEvent interface with type, sessionId, timestamp, data",
      "Define CodingAgentClient interface with createSession, resumeSession, on, registerTool, start, stop methods",
      "Add TypeScript exports in src/sdk/index.ts"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement ClaudeAgentClient using V1+V2 hybrid approach with native hooks",
    "steps": [
      "Create src/sdk/claude-client.ts file",
      "Import unstable_v2_createSession, unstable_v2_resumeSession, query from @anthropic-ai/claude-agent-sdk",
      "Define ClaudeHookConfig interface for PreToolUse, PostToolUse, SessionStart, SessionEnd, SubagentStart, SubagentStop hooks",
      "Implement ClaudeAgentClient class with eventHandlers, v2Sessions, v1Queries, hooks maps",
      "Implement registerHooks method for native SDK hook registration",
      "Implement createSession using V2 API with send/stream pattern",
      "Implement createAdvancedSession using V1 API for forking and async input",
      "Implement resumeSession using unstable_v2_resumeSession",
      "Implement wrapV2Session to create unified Session interface from V2 session",
      "Implement wrapV1Session for V1 query wrapping",
      "Implement buildNativeHooks to convert registered hooks to SDK format",
      "Implement on method for event subscription",
      "Implement registerTool using createSdkMcpServer",
      "Add unit tests with mocked SDK"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement OpenCodeClient using @opencode-ai/sdk/v2/client",
    "steps": [
      "Create src/sdk/opencode-client.ts file",
      "Import createOpencodeClient from @opencode-ai/sdk/v2/client",
      "Implement OpenCodeClient class with client, eventHandlers, eventSubscription",
      "Implement createSession using client.session.create",
      "Implement resumeSession using client.session.get",
      "Implement wrapSession with send, stream, summarize, destroy methods",
      "Implement on method for event subscription",
      "Implement start method to subscribe to events",
      "Add support for session.summarize() for context compaction",
      "Add unit tests with mocked SDK"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement CopilotClient using @github/copilot-sdk with full 31 event types support",
    "steps": [
      "Create src/sdk/copilot-client.ts file",
      "Import CopilotClient, defineTool from @github/copilot-sdk",
      "Implement CopilotClient class with client, eventHandlers, registeredTools",
      "Support useStdio, port, and cliUrl connection modes",
      "Implement createSession with tools and event subscription",
      "Subscribe to all 31 event types via session.on",
      "Implement resumeSession with event subscription",
      "Implement wrapSession with send, stream, destroy methods",
      "Implement on method with event type mapping to unified types",
      "Implement registerTool method",
      "Implement createPermissionHandler for permission approval flow",
      "Add unit tests with mocked SDK"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create unified HookManager interface for cross-SDK hook registration",
    "steps": [
      "Create src/sdk/hooks.ts file",
      "Define UnifiedHookEvent type with session.start, session.end, session.error, tool.before, tool.after, tool.error, message.before, message.after, permission.request, subagent.start, subagent.end",
      "Define HookContext interface with sessionId, agentType, timestamp, data",
      "Implement HookManager class with handlers map",
      "Implement on method for registering handlers",
      "Implement applyToClaudeClient to map unified events to Claude hooks",
      "Implement applyToCopilotClient to map unified events to Copilot events",
      "Implement applyToOpenCodeClient to map unified events to OpenCode events",
      "Implement emit method for dispatching events to handlers",
      "Add unit tests for hook registration and event mapping"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Migrate Claude hooks from .claude/settings.json to SDK options.hooks configuration",
    "steps": [
      "Identify existing hooks in .claude/settings.json",
      "Convert SessionEnd hook commands to inline TypeScript handlers",
      "Register converted hooks via ClaudeAgentClient.registerHooks()",
      "Remove hook command scripts from .claude/hooks directory",
      "Update settings.json to remove hooks configuration",
      "Verify telemetry collection still works with native hooks",
      "Add integration tests for migrated hooks"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Migrate Copilot hooks from .github/hooks/hooks.json to SDK session.on() event handlers",
    "steps": [
      "Identify existing hooks in .github/hooks/hooks.json",
      "Convert sessionStart hook to client.on('session.start') subscription",
      "Convert userPromptSubmitted hook to client.on('assistant.message') subscription",
      "Convert sessionEnd hook to client.on('session.idle') subscription",
      "Remove hook scripts from .github/scripts directory",
      "Update hooks.json to remove configurations",
      "Verify Ralph session and telemetry work with native SDK events",
      "Add integration tests for migrated hooks"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Migrate OpenCode hooks from plugin files to SDK plugin hooks",
    "steps": [
      "Identify existing plugins in .opencode/plugin/*.ts",
      "Convert plugin event handlers to OpenCodeClient.on() subscriptions",
      "Implement registerPluginHook method for tool.execute.before/after",
      "Migrate Ralph loop plugin to integrated event handlers",
      "Remove external plugin files",
      "Update opencode.json to remove plugin references",
      "Verify session continuation works with native SDK events",
      "Add integration tests for migrated hooks"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create src/graph/types.ts with all graph type definitions",
    "steps": [
      "Create src/graph/types.ts file",
      "Define BaseState interface with executionId, lastUpdated, outputs",
      "Define ExecutionContext interface with state, config, errors, abortSignal, contextWindowUsage",
      "Define NodeResult interface with stateUpdate, goto, signals",
      "Define NodeId type alias",
      "Define NodeType union type for agent, tool, decision, wait, subgraph, parallel",
      "Define NodeDefinition interface with id, type, execute, retry",
      "Define RetryConfig interface with maxAttempts, backoffMs, backoffMultiplier, retryOn",
      "Define GraphConfig interface with checkpointer, maxConcurrency, timeout, onProgress",
      "Define Signal type union for context_window_warning, checkpoint, human_input_required, debug_report_generated",
      "Define ExecutionError interface with nodeId, error, timestamp, attempt",
      "Define DebugReport interface with errorSummary, stackTrace, relevantFiles, suggestedFixes"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create src/graph/annotation.ts with state annotation system",
    "steps": [
      "Create src/graph/annotation.ts file",
      "Define Annotation interface with default and reducer",
      "Implement annotation factory function",
      "Define AnnotationRoot type for combining multiple annotations",
      "Implement Reducers.replace for simple value replacement",
      "Implement Reducers.concat for array concatenation",
      "Implement Reducers.merge for object merging",
      "Implement Reducers.mergeById for array merging by ID field",
      "Create AtomicStateAnnotation with researchDoc, specDoc, specApproved, featureList, currentFeature, allFeaturesPassing, debugReports, prUrl, contextWindowUsage, iteration",
      "Define AtomicWorkflowState type from annotation",
      "Add unit tests for annotation system and reducers"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement GraphBuilder with fluent API for workflow definition",
    "steps": [
      "Create src/graph/builder.ts file",
      "Define Edge interface with from, to, condition",
      "Define LoopConfig interface with until and maxIterations",
      "Implement GraphBuilder class with nodes, edges, startNode, endNodes, currentNode, conditionalStack",
      "Implement start() method to set starting node",
      "Implement then() method to add node and connect from current",
      "Implement if() method to begin conditional branch",
      "Implement else() method for alternative branch",
      "Implement endif() method to close conditional block",
      "Implement parallel() method for concurrent node execution with merge strategy",
      "Implement loop() method with exit condition and maxIterations",
      "Implement wait() method for human-in-the-loop prompts",
      "Implement catch() method for error recovery handlers",
      "Implement end() method to mark terminal nodes",
      "Implement compile() method to create CompiledGraph",
      "Implement graph() factory function",
      "Add unit tests for all builder methods"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement node factory functions for agent, tool, decision, wait, parallel nodes",
    "steps": [
      "Create src/graph/nodes.ts file",
      "Define AgentNodeConfig interface with agentType, systemPrompt, tools, outputMapper, sessionConfig",
      "Implement agentNode factory function with session creation, message streaming, output mapping",
      "Define ToolNodeConfig interface with toolName, args, outputMapper, timeout",
      "Implement toolNode factory function with tool execution and output mapping",
      "Define DecisionNodeConfig interface with condition and fallback",
      "Implement decisionNode factory function returning goto based on condition",
      "Define WaitNodeConfig interface with prompt, autoApprove, inputMapper",
      "Implement waitNode factory function returning human_input_required signal",
      "Define ParallelNodeConfig interface with branches, mergeStrategy, merge function",
      "Implement parallelNode factory function with Promise.all/race/any support",
      "Add default retry configuration for agent nodes",
      "Add unit tests for all node factory functions"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement CompiledGraph execution engine with streaming support",
    "steps": [
      "Create src/graph/compiled.ts file",
      "Implement CompiledGraph class with nodes, edges, startNode, endNodes, config",
      "Implement execute() method for full execution returning final state",
      "Implement stream() method as AsyncGenerator for incremental state updates",
      "Implement BFS traversal with visited tracking",
      "Implement state merging using annotation reducers",
      "Implement executeWithRetry with exponential backoff",
      "Handle goto results to override next nodes",
      "Handle signals including human_input_required to pause execution",
      "Implement checkpointing after each node completion",
      "Implement initializeState with executionId and lastUpdated",
      "Implement mergeState for immutable state updates",
      "Implement isLoopNode helper for loop node detection",
      "Add integration tests for execution engine"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement Checkpointer interface with MemorySaver, FileSaver, ResearchDirSaver",
    "steps": [
      "Create src/graph/checkpointer.ts file",
      "Define Checkpointer interface with save, load, list, delete methods",
      "Implement MemorySaver class using in-memory Map with structuredClone",
      "Implement FileSaver class using fs/promises and JSON files",
      "Implement ResearchDirSaver class storing checkpoints in research/checkpoints",
      "Use YAML frontmatter + JSON format for ResearchDirSaver",
      "Implement list() method to enumerate checkpoint IDs",
      "Implement delete() method for checkpoint cleanup",
      "Add unit tests for all checkpointer implementations"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Implement terminal chat UI using @opentui/react and @opentui/core",
    "steps": [
      "Install @opentui/core and @opentui/react dependencies",
      "Create src/ui/chat.tsx file",
      "Define ChatMessage interface with id, role, content, timestamp, streaming",
      "Define ChatAppProps interface with onSendMessage, onStreamMessage, onExit",
      "Implement ChatApp component with messages state and isStreaming state",
      "Use useKeyboard hook for ESC and Ctrl+C to exit",
      "Implement handleSubmit callback for message submission",
      "Render header box with exit instructions",
      "Render scrollbox with stickyScroll and stickyStart='bottom' for message history",
      "Render input area with disabled state during streaming",
      "Implement MessageBubble component with role-based styling"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Implement streaming message display with MarkdownRenderable",
    "steps": [
      "Use markdown renderable in MessageBubble component",
      "Pass streaming prop to markdown component",
      "Handle partial content during streaming",
      "Update message content incrementally via state updates",
      "Display typing indicator during streaming",
      "Handle stream completion to remove streaming flag"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Implement sticky scroll chat history with ScrollBoxRenderable",
    "steps": [
      "Configure scrollbox with stickyScroll=true",
      "Set stickyStart='bottom' for auto-scroll to latest messages",
      "Enable viewportCulling for performance",
      "Handle flexGrow for responsive height",
      "Add border and title for chat history section"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Add syntax-highlighted code blocks via CodeRenderable",
    "steps": [
      "Create src/ui/code-block.tsx file",
      "Define CodeBlockProps interface with content, language, streaming",
      "Implement CodeBlock component using code renderable",
      "Set syntaxStyle to monokai",
      "Support streaming prop for live code updates",
      "Implement extractCodeBlocks function to parse markdown code blocks",
      "Add border and padding styling"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Implement theme support with dark/light modes",
    "steps": [
      "Create src/ui/theme.ts file",
      "Define Theme interface with name and colors",
      "Define darkTheme with background, foreground, accent, border, userMessage, assistantMessage, error, success, warning colors",
      "Define lightTheme with equivalent light mode colors",
      "Create ThemeContext using React createContext",
      "Implement useTheme hook",
      "Implement ThemeProvider component",
      "Apply theme colors to ChatApp and MessageBubble components"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Implement CLI integration for chat UI",
    "steps": [
      "Create src/ui/index.ts file",
      "Implement startChatUI function accepting client and sessionConfig",
      "Create renderer using createCliRenderer",
      "Implement handleSendMessage to create session and send messages",
      "Implement handleStreamMessage as async generator",
      "Implement handleExit with session cleanup and renderer destruction",
      "Ensure unmount before destroy to avoid Yoga crash",
      "Handle SIGINT and SIGTERM signals for cleanup",
      "Export startChatUI function"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Create unified TelemetryCollector interface for cross-SDK event tracking",
    "steps": [
      "Create src/telemetry/types.ts file",
      "Define TelemetryEvent interface with eventId, timestamp, eventType, sessionId, executionId, properties",
      "Define TelemetryEventType union for SDK, graph, workflow, and UI events",
      "Define TelemetryCollector interface with track, flush, isEnabled, shutdown methods"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement UnifiedTelemetryCollector with JSONL logging and Azure App Insights",
    "steps": [
      "Create src/telemetry/collector.ts file",
      "Implement UnifiedTelemetryCollector class with events array and config",
      "Generate stable anonymousId from machine characteristics",
      "Implement isEnabled() checking DO_NOT_TRACK and ATOMIC_TELEMETRY env vars",
      "Implement track() method with eventId and timestamp generation",
      "Add anonymousId, platform, nodeVersion to event properties",
      "Implement auto-flush when batchSize (100) reached",
      "Implement flush() method calling writeToLocalLog and sendToAppInsights",
      "Implement writeToLocalLog writing JSONL files",
      "Implement sendToAppInsights posting to Azure endpoint",
      "Implement shutdown() clearing interval and flushing",
      "Start flush interval (30 seconds) if enabled"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement SDK telemetry integration with withTelemetry wrapper",
    "steps": [
      "Create src/telemetry/sdk-integration.ts file",
      "Implement withTelemetry function wrapping CodingAgentClient",
      "Track sdk.session.created on createSession",
      "Track sdk.session.resumed on resumeSession",
      "Wrap sessions with wrapSession function",
      "Track sdk.message.sent on session.send",
      "Track sdk.session.destroyed on session.destroy",
      "Wrap on method to track all SDK events",
      "Implement mapEventType for event type translation"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement graph telemetry integration for workflow tracking",
    "steps": [
      "Create src/telemetry/graph-integration.ts file",
      "Implement withGraphTelemetry function adding telemetry to GraphConfig",
      "Track graph.node.completed in onProgress callback",
      "Implement trackGraphExecution factory returning started, completed, failed, checkpointSaved functions",
      "Track graph.execution.started on workflow start",
      "Track graph.execution.completed with totalIterations and featureCount",
      "Track graph.execution.failed with errorMessage and nodeId",
      "Track graph.checkpoint.saved with label"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement consent-based telemetry collection with DO_NOT_TRACK support",
    "steps": [
      "Create src/telemetry/config.ts file",
      "Define TelemetryConfig interface with enabled, localLogPath, appInsightsKey",
      "Implement loadTelemetryConfig function",
      "Check DO_NOT_TRACK=1 environment variable",
      "Check ATOMIC_TELEMETRY=0 environment variable",
      "Determine platform-specific data directory",
      "Set localLogPath to {dataDir}/telemetry",
      "Load appInsightsKey from ATOMIC_APP_INSIGHTS_KEY env var",
      "Document opt-out methods in README"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Migrate Ralph loop to graph-based execution",
    "steps": [
      "Create src/workflows/atomic.ts file",
      "Create research agentNode with codebase-research-analyzer type",
      "Create createSpec agentNode for spec generation",
      "Create reviewSpec decisionNode checking specApproved",
      "Create waitForApproval waitNode for human review",
      "Create createFeatureList agentNode for feature extraction",
      "Create selectFeature decisionNode for feature selection",
      "Create implementFeature agentNode for feature implementation",
      "Create createPR toolNode using gh CLI",
      "Build graph with start, then, loop, end chain",
      "Configure loop until allFeaturesPassing with maxIterations 100",
      "Compile graph with ResearchDirSaver checkpointer",
      "Export createAtomicWorkflow function"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement context window monitoring with configurable thresholds",
    "steps": [
      "Add contextWindowUsage field to AtomicWorkflowState",
      "Implement getContextUsage method in Session interface",
      "Create context monitoring node checking usage",
      "Emit context_window_warning signal at 60% threshold",
      "Call session.summarize() for OpenCode client on warning",
      "Recreate session for Claude client on warning",
      "Add configurable threshold via GraphConfig"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Support human-in-the-loop approval for spec review",
    "steps": [
      "Implement waitForApproval waitNode in Atomic workflow",
      "Display spec content in prompt",
      "Return human_input_required signal",
      "Pause graph execution on signal",
      "Resume with specApproved state update on approval",
      "Route to createFeatureList on approval",
      "Route to createSpec for revision on rejection"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Update atomic ralph setup command to use graph engine",
    "steps": [
      "Add ATOMIC_USE_GRAPH_ENGINE feature flag",
      "Import createAtomicWorkflow in ralph command",
      "Create client based on agent type flag",
      "Compile workflow with telemetry and checkpointing",
      "Execute workflow with initial state",
      "Stream state updates to display progress",
      "Handle human_input_required signals for approvals",
      "Display final PR URL on completion"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Integrate OpenTUI chat interface with graph workflows",
    "steps": [
      "Create unified chat command in CLI",
      "Initialize selected SDK client",
      "Start chat UI with startChatUI",
      "Connect chat messages to graph execution",
      "Display workflow progress in chat",
      "Handle approval prompts in chat UI",
      "Display code blocks with syntax highlighting",
      "Support theme switching via command"
    ],
    "passes": true
  },
  {
    "category": "performance",
    "description": "Implement retry logic with exponential backoff for node execution",
    "steps": [
      "Define RetryConfig in node definition",
      "Set default maxAttempts to 3 for agent nodes",
      "Set default backoffMs to 1000",
      "Set default backoffMultiplier to 2",
      "Implement executeWithRetry in CompiledGraph",
      "Apply delay between retry attempts",
      "Support retryOn predicate for selective retry",
      "Track attempt count in ExecutionError"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Add feature flag ATOMIC_USE_GRAPH_ENGINE for rollout",
    "steps": [
      "Check ATOMIC_USE_GRAPH_ENGINE environment variable",
      "Default to false during initial rollout",
      "Use hook-based execution when flag is false",
      "Use graph-based execution when flag is true",
      "Document flag in README",
      "Add flag to configuration schema",
      "Plan to enable by default in Phase 8"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Create unit tests for GraphBuilder fluent API",
    "steps": [
      "Create tests/graph/builder.test.ts file",
      "Test linear graph building with start and then",
      "Test loop exits on condition",
      "Test parallel node execution",
      "Test conditional branching with if/else/endif",
      "Test wait node signal emission",
      "Test catch error handling",
      "Test compile produces valid CompiledGraph"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Create integration tests for SDK clients",
    "steps": [
      "Create tests/sdk/claude-client.test.ts file",
      "Test session creation and streaming",
      "Create tests/sdk/opencode-client.test.ts file",
      "Test session creation with summarize",
      "Create tests/sdk/copilot-client.test.ts file",
      "Test session with tool registration",
      "Create tests/sdk/hooks.test.ts file",
      "Test HookManager event mapping",
      "Use mocked SDK responses for unit tests"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Create end-to-end tests for Atomic workflow",
    "steps": [
      "Create tests/workflows/atomic.test.ts file",
      "Test workflow completes with checkpoints",
      "Test context compaction triggers at threshold",
      "Test error recovery with catch handler",
      "Test human-in-the-loop approval flow",
      "Test PR creation on completion",
      "Run with bun test:e2e:graph command"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Update README with graph engine documentation",
    "steps": [
      "Document graph engine architecture",
      "Document workflow definition using fluent API",
      "Document node types and factory functions",
      "Document checkpointing and resumption",
      "Document telemetry collection and opt-out",
      "Document OpenTUI chat interface usage",
      "Create migration guide for existing Ralph users"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create src/sdk/index.ts with all SDK exports",
    "steps": [
      "Export all types from types.ts",
      "Export ClaudeAgentClient from claude-client.ts",
      "Export OpenCodeClient from opencode-client.ts",
      "Export CopilotClient from copilot-client.ts",
      "Export HookManager and hook types from hooks.ts",
      "Export createPermissionHandler from copilot-client.ts"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create src/graph/index.ts with all graph exports",
    "steps": [
      "Export all types from types.ts",
      "Export annotation and Reducers from annotation.ts",
      "Export all node factory functions from nodes.ts",
      "Export GraphBuilder and graph function from builder.ts",
      "Export CompiledGraph from compiled.ts",
      "Export Checkpointer, MemorySaver, FileSaver, ResearchDirSaver from checkpointer.ts"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create src/telemetry/index.ts with all telemetry exports",
    "steps": [
      "Export all types from types.ts",
      "Export UnifiedTelemetryCollector from collector.ts",
      "Export withTelemetry from sdk-integration.ts",
      "Export withGraphTelemetry and trackGraphExecution from graph-integration.ts",
      "Export loadTelemetryConfig from config.ts"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create src/workflows/index.ts with workflow exports",
    "steps": [
      "Export createAtomicWorkflow from atomic.ts",
      "Export AtomicWorkflowState type from atomic.ts"
    ],
    "passes": false
  }
]
