[
  {
    "category": "functional",
    "description": "Define CliCommandEvent type in types.ts following existing AtomicCommandEvent pattern",
    "steps": [
      "Open src/utils/telemetry/types.ts",
      "Add CliCommandEvent interface with fields: anonymousId, eventId, eventType ('cli_command'), timestamp, agentType, commands (string[]), commandCount (number), platform, atomicVersion, source ('cli')",
      "Add JSDoc comments referencing Spec Section 5.3.2",
      "Ensure interface follows existing naming conventions and patterns",
      "Verify TypeScript compilation passes with bun build"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement extractCommandsFromArgs utility function with Single Responsibility",
    "steps": [
      "Open src/utils/telemetry/telemetry-cli.ts",
      "Import ATOMIC_COMMANDS from ./constants",
      "Create extractCommandsFromArgs(args: string[]): string[] function",
      "Iterate through args and check if each arg matches or starts with a known command",
      "Use exact match (arg === cmd) or prefix match (arg.startsWith(cmd + ' ')) as per spec",
      "Return deduplicated array using Set spread pattern",
      "Add JSDoc comments explaining the extraction logic",
      "Keep function pure with no side effects (functional core pattern)"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Update appendEvent to support CliCommandEvent type using union type",
    "steps": [
      "Open src/utils/telemetry/telemetry-cli.ts",
      "Import CliCommandEvent type from ./types",
      "Update appendEvent function signature to accept AtomicCommandEvent | CliCommandEvent",
      "Verify function body works with both event types (JSON.stringify is polymorphic)",
      "Keep implementation DRY - avoid duplicating append logic"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement trackCliInvocation function following Open/Closed principle",
    "steps": [
      "Open src/utils/telemetry/telemetry-cli.ts",
      "Create trackCliInvocation(agentType: AgentType, args: string[]): void function",
      "Check telemetry enabled via isTelemetryEnabledSync() - early return pattern",
      "Extract commands using extractCommandsFromArgs(args)",
      "Return early if no commands found (don't log empty events)",
      "Create CliCommandEvent using createBaseEvent() factory pattern",
      "Spread baseFields and add cli_command specific fields",
      "Call appendEvent with the constructed event",
      "Add JSDoc comments with @example usage blocks",
      "Maintain fail-safe pattern - telemetry should never break CLI"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Export new functions from telemetry/index.ts following Interface Segregation",
    "steps": [
      "Open src/utils/telemetry/index.ts",
      "Add CliCommandEvent to the exported types",
      "Add trackCliInvocation to the CLI telemetry tracking exports",
      "Keep exports organized in logical groups (types, constants, core, cli)",
      "Ensure public API surface is minimal and intentional"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Integrate trackCliInvocation into run-agent.ts before Bun.spawn",
    "steps": [
      "Open src/commands/run-agent.ts",
      "Import trackCliInvocation from ../utils/telemetry",
      "Before the Bun.spawn call (line 124), add trackCliInvocation call",
      "Pass agentKey (cast to AgentType) and agentArgs to trackCliInvocation",
      "Place tracking after all validation but before process spawn",
      "Maintain existing trackAtomicCommand call for 'run' command",
      "Document why both tracking calls exist (different event types)"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create union type TelemetryEvent for extensibility",
    "steps": [
      "Open src/utils/telemetry/types.ts",
      "Add TelemetryEvent type alias: AtomicCommandEvent | CliCommandEvent",
      "Export TelemetryEvent from types.ts",
      "Export TelemetryEvent from index.ts",
      "This prepares for Phase 4 AgentSessionEvent addition (anticipate change)"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Write unit tests for extractCommandsFromArgs edge cases",
    "steps": [
      "Open or create src/utils/telemetry/telemetry-cli.test.ts",
      "Test exact command match: ['/research-codebase'] returns ['/research-codebase']",
      "Test command with args: ['/research-codebase src/'] returns ['/research-codebase']",
      "Test multiple commands: ['/research-codebase', '/commit'] returns both",
      "Test no commands: ['src/', '--verbose'] returns []",
      "Test deduplication: ['/commit', '/commit'] returns ['/commit']",
      "Test mixed valid/invalid: ['/commit', '--help', '/unknown'] returns ['/commit']",
      "Test namespaced commands: ['/ralph:ralph-loop'] returns ['/ralph:ralph-loop']",
      "Run tests with bun test src/utils/telemetry/telemetry-cli.test.ts"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Write unit tests for trackCliInvocation behavior",
    "steps": [
      "Continue in src/utils/telemetry/telemetry-cli.test.ts",
      "Mock isTelemetryEnabledSync to control test behavior",
      "Test: when telemetry disabled, no event is written",
      "Test: when args contain no commands, no event is written",
      "Test: when args contain commands, CliCommandEvent is written to JSONL",
      "Test: event contains correct commandCount matching commands array length",
      "Test: eventType is 'cli_command' not 'atomic_command'",
      "Use temp directory for events file to avoid polluting real telemetry",
      "Run tests with bun test src/utils/telemetry/telemetry-cli.test.ts"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Write integration test for full CLI invocation tracking flow",
    "steps": [
      "Open or create src/utils/telemetry/telemetry-integration.test.ts",
      "Create test: 'tracks slash commands from CLI invocation'",
      "Enable telemetry in test setup (mock state)",
      "Call trackCliInvocation('claude', ['/research-codebase', 'src/'])",
      "Read telemetry-events.jsonl and parse the event",
      "Verify event structure matches CliCommandEvent interface",
      "Verify commands array is ['/research-codebase']",
      "Verify agentType is 'claude'",
      "Verify source is 'cli'",
      "Clean up temp files in afterEach",
      "Run tests with bun test src/utils/telemetry/"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Run full test suite and verify no regressions",
    "steps": [
      "Run bun test to execute all tests",
      "Verify existing Phase 1 and Phase 2 tests still pass",
      "Verify new Phase 3 tests pass",
      "Run bun run lint to check for linting issues",
      "Run bun run typecheck to verify TypeScript compilation",
      "Fix any failures before marking phase complete"
    ],
    "passes": true
  }
]
