[
  {
    "category": "functional",
    "description": "Create telemetry-cli.ts module with trackAtomicCommand function",
    "steps": [
      "Create src/utils/telemetry/telemetry-cli.ts file",
      "Define AtomicCommandEvent interface matching spec Section 5.3.1 schema",
      "Implement trackAtomicCommand(command, agentType, success) function",
      "Function should check isTelemetryEnabled() before writing",
      "Generate unique eventId using crypto.randomUUID()",
      "Get anonymousId from getOrCreateTelemetryState()",
      "Capture platform from process.platform",
      "Capture atomicVersion from VERSION constant",
      "Return early (no-op) if telemetry is disabled",
      "Export trackAtomicCommand from telemetry/index.ts"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Implement JSONL event buffering to telemetry-events.jsonl",
    "steps": [
      "Add getEventsFilePath() function returning ~/.local/share/atomic/telemetry-events.jsonl",
      "Create appendEvent(event) function for atomic append-only writes",
      "Use fs.appendFileSync to write JSON + newline to JSONL file",
      "Ensure data directory exists before writing (use getBinaryDataDir helper)",
      "Handle write failures silently (fail-safe, non-blocking)",
      "Add unit tests for JSONL append with multiple concurrent writes"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Integrate trackAtomicCommand into init command",
    "steps": [
      "Import trackAtomicCommand in src/commands/init.ts",
      "Call trackAtomicCommand('init', agentKey, true) after successful completion (line ~257)",
      "Call trackAtomicCommand('init', agentKey, false) in catch block for failures",
      "Track agentType as the selected agent key (claude, opencode, copilot)",
      "Ensure tracking happens before process.exit calls",
      "Add integration test for init command telemetry event"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Integrate trackAtomicCommand into update command",
    "steps": [
      "Read src/commands/update.ts to understand command structure",
      "Import trackAtomicCommand in src/commands/update.ts",
      "Call trackAtomicCommand('update', null, true) on successful update",
      "Call trackAtomicCommand('update', null, false) on update failure",
      "agentType should be null since update is not agent-specific",
      "Add integration test for update command telemetry event"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Integrate trackAtomicCommand into uninstall command",
    "steps": [
      "Read src/commands/uninstall.ts to understand command structure",
      "Import trackAtomicCommand in src/commands/uninstall.ts",
      "Call trackAtomicCommand('uninstall', null, true) on successful uninstall",
      "Call trackAtomicCommand('uninstall', null, false) on uninstall failure",
      "agentType should be null since uninstall is not agent-specific",
      "Add integration test for uninstall command telemetry event"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Track run command in run-agent.ts with agent type",
    "steps": [
      "Import trackAtomicCommand in src/commands/run-agent.ts",
      "Call trackAtomicCommand('run', agentKey, true) before Bun.spawn (line ~119)",
      "Track agentType as the validated agent key",
      "Do not track exit code as success/failure (agent exit codes are agent-specific)",
      "success should always be true if we reach the spawn point",
      "Add integration test for run command telemetry event"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Add event type definitions for all telemetry events",
    "steps": [
      "Add AtomicCommandEvent interface to src/utils/telemetry/types.ts",
      "Define command union type: 'init' | 'update' | 'uninstall' | 'run'",
      "Define agentType union type: 'claude' | 'opencode' | 'copilot' | null",
      "Include eventId, eventType, timestamp, success, platform, atomicVersion, source fields",
      "Export new types from telemetry/index.ts",
      "Ensure types match spec Section 5.3.1 exactly"
    ],
    "passes": true
  },
  {
    "category": "refactor",
    "description": "Create shared event factory following Factory pattern",
    "steps": [
      "Create createBaseEvent() function in telemetry-cli.ts",
      "Factory generates common fields: anonymousId, eventId, timestamp, platform, atomicVersion, source",
      "Use composition to build specific event types on top of base",
      "Reduces duplication across trackAtomicCommand and future trackCliInvocation",
      "Follow Open/Closed principle - base is closed for modification, open for extension"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Write comprehensive unit tests for telemetry-cli module",
    "steps": [
      "Create src/utils/telemetry/telemetry-cli.test.ts",
      "Test trackAtomicCommand writes correct event structure to JSONL",
      "Test trackAtomicCommand respects isTelemetryEnabled() check",
      "Test JSONL file is created if it doesn't exist",
      "Test multiple events append correctly (newline delimited)",
      "Test event fields match expected schema",
      "Mock file system to avoid polluting actual telemetry file"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "description": "Write integration tests for command tracking end-to-end",
    "steps": [
      "Create src/utils/telemetry/telemetry-integration.test.ts",
      "Test init command produces atomic_command event in JSONL",
      "Test update command produces atomic_command event",
      "Test run command produces atomic_command event with agentType",
      "Test opt-out via ATOMIC_TELEMETRY=0 prevents event writing",
      "Test opt-out via DO_NOT_TRACK=1 prevents event writing",
      "Use temporary directory for test isolation"
    ],
    "passes": true
  }
]
