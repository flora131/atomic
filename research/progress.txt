## 2026-02-03 - Feature Implementation: Integration test: Permission bypass configuration per SDK

### Status: COMPLETED

Implemented comprehensive integration tests for permission bypass configuration across all three SDK clients (Claude, OpenCode, Copilot), validating that tools auto-execute without prompts while AskUserQuestion still pauses for human input.

#### Tests Added (37 new tests)

1. **Claude SDK with permissionMode: bypassPermissions**
   - client has bypass permission mode configured
   - session is created with bypass permission mode
   - tools execute without prompts in bypass mode
   - Bash commands execute without prompt in bypass mode
   - file edits execute without prompt in bypass mode
   - web operations execute without prompt in bypass mode
   - allowDangerouslySkipPermissions is implicitly set in bypass mode
   - session config can override client permission mode

2. **OpenCode SDK with permission: { default: allow }**
   - client has allow permission config
   - tools execute without prompts with allow config
   - Bash commands auto-execute with allow config
   - file edits auto-execute with allow config
   - all tools auto-execute when permission.default is allow
   - ask rules are removed with allow config

3. **OpenCode SDK with permission: deny (comparison test)**
   - tools require prompts with deny/ask config

4. **Copilot SDK with no PermissionHandler**
   - client has no permission handler configured
   - all tools auto-execute without PermissionHandler
   - Bash commands execute without prompt
   - file edits execute without prompt
   - web operations execute without prompt
   - this is equivalent to --allow-all mode

5. **Copilot SDK with PermissionHandler (comparison test)**
   - client has permission handler configured
   - tools would be prompted with PermissionHandler

6. **All tools execute without prompts across SDKs**
   - Bash commands execute without prompts on all SDKs
   - file edits execute without prompts on all SDKs
   - web searches execute without prompts on all SDKs

7. **AskUserQuestion still pauses for input**
   - Claude SDK AskUserQuestion pauses execution
   - OpenCode SDK AskUserQuestion pauses execution
   - Copilot SDK AskUserQuestion pauses execution
   - AskUserQuestion blocks until user responds
   - human_input_required event is emitted for AskUserQuestion
   - workflow state includes __waitingForInput: true during AskUserQuestion

8. **Edge cases**
   - multiple tools execute sequentially without prompts
   - AskUserQuestion works correctly after tool executions
   - tool executions continue after user responds to AskUserQuestion
   - concurrent sessions maintain independent permission state
   - permission mode is preserved across session resume

#### Test Results
- All 37 tests pass
- No regressions detected in existing tests

#### Files Added
- tests/sdk/permission-bypass-integration.test.ts - 37 comprehensive integration tests for permission bypass configuration per SDK

#### Files Modified
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Integration test: Context window management with clearContextNode

### Status: COMPLETED

Implemented comprehensive integration tests for context window management with clearContextNode, validating the behavior of context clearing within loop iterations and state preservation across context clears.

#### Tests Added (32 new tests)

1. **Creating workflow with loop containing clearContextNode**
   - clearContextNode can be added to workflow
   - workflow with clearContextNode inside loop has correct structure
   - clearContextNode is of type tool
   - clearContextNode has correct name and description

2. **Execute multiple loop iterations**
   - workflow executes loop with clearContextNode multiple times
   - clearContextNode executes at start of each iteration
   - loop respects maxIterations limit with clearContextNode

3. **Verify context cleared at start of each iteration**
   - clearContextNode emits context_window_warning signal
   - context_window_warning signal has action: summarize
   - context_window_warning signal contains correct message
   - dynamic message is resolved from state
   - clearContextNode emits signal with usage: 100 to force summarization
   - clearContextNode signal includes nodeId

4. **Verify state preserved across context clears**
   - important data is preserved after clearContextNode execution
   - accumulated values are preserved across loop iterations with clearContextNode
   - executedNodes array preserves all node executions across context clears
   - outputs object is preserved across context clears
   - loop counter state is preserved and incremented correctly
   - data object accumulates values across iterations with context clears

5. **Verify workflow completes successfully**
   - workflow completes successfully with clearContextNode in loop
   - workflow with single iteration loop completes
   - workflow with clearContextNode completes even when until is immediately true
   - workflow execution status is completed, not failed or cancelled

6. **ClearContextNode with complex workflows**
   - clearContextNode works with multiple nodes in loop body
   - clearContextNode with conditional branching inside loop
   - nested workflows with clearContextNode

7. **ClearContextNode edge cases**
   - clearContextNode with undefined message uses default
   - clearContextNode does not modify state directly
   - multiple clearContextNodes in sequence
   - abort signal cancels workflow at clearContextNode

8. **Integration with Ralph workflow patterns**
   - clearContextNode placement at loop start matches Ralph workflow
   - context clears prevent context window overflow pattern

#### Test Results
- All 32 tests pass
- All 334 workflow tests pass (no regressions)

#### Files Added
- tests/workflows/clearcontext-node-integration.test.ts - 32 comprehensive integration tests for context window management with clearContextNode

#### Files Modified
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Integration test: Checkpoint save/restore to session directory

### Status: COMPLETED

Implemented comprehensive integration tests for checkpoint save/restore functionality in Ralph session directories, validating the complete checkpoint lifecycle including save, restore, and workflow resumption.

#### Tests Added (30 new tests)

1. **Execute Ralph workflow with checkpointing enabled**
   - workflow executes successfully with checkpointing enabled
   - workflow with dynamic session directory checkpointing executes successfully
   - checkpointing does not affect workflow behavior

2. **Verify checkpoints saved to session directory**
   - checkpoints are saved to session checkpoints directory
   - checkpoint files contain valid JSON state
   - checkpoints use sequential naming (node-001, node-002, etc.)
   - checkpoint state reflects execution progress
   - dynamic session directory checkpointing saves to correct location

3. **Interrupt workflow mid-execution**
   - workflow can be interrupted via AbortController
   - interrupted workflow saves checkpoint before stopping
   - streaming execution allows inspection of each step

4. **Create new workflow execution with resume**
   - can load checkpoint from session directory
   - can list available checkpoints in session directory
   - can load specific checkpoint by label
   - can create workflow with resumeFrom snapshot

5. **Verify state restored from checkpoint**
   - restored state matches saved state
   - restored state has correct type information
   - restoring from checkpoint updates internal counter
   - session directory is preserved in restored state

6. **Verify execution continues from checkpoint**
   - execution can resume from saved checkpoint state
   - resumed execution does not duplicate previous work
   - new checkpoints saved after resume continue sequence
   - workflow with resumeFrom snapshot continues execution

7. **Checkpoint edge cases**
   - handles empty checkpoints directory gracefully
   - handles concurrent checkpoint saves
   - checkpoint state survives JSON serialization round-trip
   - can delete checkpoints from session directory
   - can delete all checkpoints for an execution

8. **Integration with RalphWorkflowState**
   - can checkpoint RalphWorkflowState
   - RalphWorkflowState features are preserved across checkpoint

#### Test Results
- All 30 tests pass
- All 302 workflow tests pass (no regressions)

#### Files Added
- tests/workflows/checkpoint-session-integration.test.ts - 30 comprehensive integration tests for checkpoint save/restore to session directory

#### Files Modified
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Integration test: AskUserQuestion node pauses and resumes

### Status: COMPLETED

Implemented comprehensive integration tests for AskUserQuestion node pause and resume behavior, validating the full workflow execution lifecycle with human-in-the-loop interactions.

#### Tests Added (18 new tests)

1. **Creating workflow with askUserNode**
   - askUserNode can be added to workflow
   - workflow with askUserNode has correct structure

2. **Execution pauses at AskUserQuestion**
   - workflow execution pauses when askUserNode is reached
   - workflow streams correctly and pauses at askUserNode

3. **Verify __waitingForInput is true in state**
   - state has __waitingForInput set to true when paused
   - state has __waitNodeId set to askUserNode id
   - state has __askUserRequestId set (UUID format)

4. **Verify human_input_required signal is emitted**
   - askUserNode emits human_input_required signal
   - human_input_required signal contains question data
   - human_input_required signal requestId matches state requestId

5. **Simulate user response and resume execution**
   - workflow can be resumed from paused state using snapshot
   - user answer is available in state after resume

6. **Multiple askUserNodes in workflow**
   - workflow with multiple askUserNodes pauses at each

7. **Dynamic question based on state**
   - askUserNode question can be dynamic based on state

8. **askUserNode with structured options**
   - options are correctly passed through in signal
   - askUserNode without options emits signal without options array

9. **Abort handling during askUserNode**
   - workflow can be cancelled while waiting at askUserNode

10. **Unique requestIds for each askUserNode execution**
    - each askUserNode execution generates unique requestId

#### Test Results
- All 18 tests pass
- No regressions detected

#### Files Added
- tests/workflows/askuser-node-integration.test.ts - 18 comprehensive integration tests for AskUserQuestion node pause/resume behavior

#### Files Modified
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Unit test: Session state serialization/deserialization

### Status: COMPLETED

Implemented comprehensive unit tests for session state serialization/deserialization functionality, validating saveSession(), loadSession(), and loadSessionIfExists() operations.

#### Tests Added (32 new tests)

1. **Create RalphSession object with all fields**
   - creates session with all required fields populated
   - creates session with all optional fields populated
   - creates session with multiple features at different statuses
   - creates session in all valid status states
   - session with debugReports is valid

2. **saveSession() writes valid JSON**
   - saveSession writes session to session.json file
   - saveSession writes parseable JSON content
   - saveSession preserves all session fields in JSON
   - saveSession writes properly formatted JSON with indentation
   - saveSession handles special characters in feature names
   - saveSession overwrites existing session.json

3. **loadSession() reads and parses correctly**
   - loadSession reads and parses session.json correctly
   - loadSession returns typed RalphSession object
   - loadSession preserves all feature fields
   - loadSession throws for non-existent session directory
   - loadSession throws for invalid JSON
   - loadSession throws for valid JSON with missing required fields
   - loadSession validates session status
   - loadSession round-trips complex session data

4. **loadSessionIfExists() returns null for missing session**
   - loadSessionIfExists returns null for non-existent directory
   - loadSessionIfExists returns null for empty directory
   - loadSessionIfExists returns null for invalid session.json
   - loadSessionIfExists returns null for structurally invalid session
   - loadSessionIfExists returns session when it exists and is valid
   - loadSessionIfExists is safe to call multiple times
   - loadSessionIfExists differentiates between file not found and invalid data

5. **lastUpdated updated on save**
   - saveSession updates lastUpdated to current time
   - createdAt is preserved on save (not updated)
   - multiple saves update lastUpdated each time
   - lastUpdated is in valid ISO 8601 format
   - saveSession original object is not mutated
   - saved lastUpdated reflects actual save time accurately

#### Test Results
- All 102 tests in tests/workflows/ralph-session.test.ts pass (32 new tests added)
- No regressions detected

#### Files Modified
- tests/workflows/ralph-session.test.ts - Added 32 new comprehensive tests for session state serialization/deserialization
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Unit test: Session directory creation

### Status: COMPLETED

Implemented comprehensive unit tests for session directory creation functionality, validating the .ralph/sessions/{uuid}/ structure, subdirectories, and file initialization.

#### Tests Added (23 new tests)

1. **createSessionDirectory creates .ralph/sessions/{uuid}/**
   - creates directory at exact path .ralph/sessions/{sessionId}/
   - creates parent directories (.ralph and .ralph/sessions) if they don't exist
   - creates session directory with UUID-formatted sessionId
   - handles sessionId with special characters gracefully

2. **all subdirectories created: checkpoints/, research/, logs/**
   - creates checkpoints/ subdirectory
   - creates research/ subdirectory
   - creates logs/ subdirectory
   - creates all three subdirectories in a single call
   - subdirectories are empty when first created

3. **session.json initialized correctly**
   - session.json contains all required fields
   - session.json has valid initial status of 'running'
   - session.json is valid JSON with proper formatting
   - session.json is readable and parseable after creation
   - session.json timestamps are valid ISO 8601 strings
   - session.json iteration starts at 1
   - session.json currentFeatureIndex starts at 0

4. **progress.txt initialized with header**
   - progress.txt header contains session title
   - progress.txt entries maintain order
   - progress.txt uses correct status indicators

5. **feature-list.json copied when not yolo mode**
   - feature-list.json is created in research/ subdirectory for non-yolo sessions
   - feature-list.json preserves feature data accurately
   - feature-list.json is not created in yolo mode
   - feature-list.json is valid JSON format

#### Test Results
- All 70 tests in tests/workflows/ralph-session.test.ts pass (23 new tests added)
- All 229 tests in tests/graph/nodes/ralph-nodes.test.ts pass
- No regressions detected

#### Files Modified
- tests/workflows/ralph-session.test.ts - Added 23 new comprehensive tests for session directory creation
- research/feature-list.json - Updated passes to true for this feature

---

# Progress Log

## 2026-02-03 - Feature Implementation: Unit test: Agent frontmatter parsing across SDK formats

### Status: COMPLETED

Implemented comprehensive unit tests for agent frontmatter parsing across different SDK formats (Claude, OpenCode, Copilot).

#### Tests Added (53 new tests)

1. **Claude format: tools as string array**
   - parses Claude format with tools as string array
   - Claude format tools array is passed through unchanged
   - Claude format with empty tools array
   - Claude format with single tool
   - Claude format tools preserve case

2. **OpenCode format: tools as Record<string, boolean>**
   - parses OpenCode format with tools as Record<string, boolean>
   - OpenCode format converts Record to array of enabled tools
   - OpenCode format with all tools disabled
   - OpenCode format with all tools enabled
   - OpenCode format mode field is ignored in AgentDefinition
   - OpenCode format with primary mode is still parsed

3. **Model normalization: 'anthropic/claude-3-sonnet' -> 'sonnet'**
   - normalizes anthropic/claude-3-sonnet to sonnet
   - normalizes anthropic/claude-3.5-sonnet to sonnet
   - normalizes anthropic/claude-3-opus to opus
   - normalizes anthropic/claude-3.5-opus to opus
   - normalizes anthropic/claude-3-haiku to haiku
   - normalizes anthropic/claude-3.5-haiku to haiku
   - normalizes direct model names (sonnet, opus, haiku)
   - model normalization in parseAgentFrontmatter
   - model normalization handles partial matches
   - model normalization returns undefined for unknown models
   - model normalization returns undefined for undefined input

4. **Missing optional fields use defaults**
   - missing name uses filename as default
   - missing description uses default description
   - missing description with only filename uses filename in default
   - missing tools field results in undefined tools
   - missing model field results in undefined model
   - minimal frontmatter with only required source creates valid agent
   - empty body results in empty prompt string
   - whitespace-only body is trimmed to empty string

5. **Invalid frontmatter handled gracefully**
   - parseMarkdownFrontmatter returns null for content without frontmatter delimiters
   - parseMarkdownFrontmatter returns null for unclosed frontmatter
   - parseMarkdownFrontmatter returns null for frontmatter without opening delimiter
   - parseAgentFile returns agent with defaults for content without frontmatter
   - parseAgentFile returns null for non-existent file
   - parseAgentFrontmatter handles undefined values gracefully
   - parseAgentFrontmatter handles null values gracefully
   - parseAgentFrontmatter handles wrong types for tools field
   - normalizeTools passes through arrays
   - normalizeTools converts object to array of enabled tools
   - normalizeTools returns undefined for undefined input
   - normalizeModel returns undefined for empty string
   - parseMarkdownFrontmatter handles empty frontmatter section
   - parseMarkdownFrontmatter returns null for truly empty frontmatter
   - parseMarkdownFrontmatter handles malformed YAML in frontmatter
   - parseMarkdownFrontmatter handles frontmatter with only comments

6. **Copilot format compatibility**
   - parses Copilot format with string array tools
   - Copilot format tools are preserved as-is

7. **Full parsing flow with parseAgentFile**
   - parseAgentFile correctly parses Claude format file
   - parseAgentFile correctly parses OpenCode format file
   - parseAgentFile correctly parses minimal format file

#### Test Results
- All 295 tests in tests/ui/commands/agent-commands.test.ts pass (53 new tests added)
- No regressions detected

#### Files Modified
- tests/ui/commands/agent-commands.test.ts - Added 53 new tests for agent frontmatter parsing across SDK formats
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Unit test: Sub-agent discovery from agent directories

### Status: COMPLETED

Implemented comprehensive unit tests for sub-agent discovery from multiple agent directories (`.claude/agents/`, `.opencode/agents/`, `.github/agents/`, `.atomic/agents/`).

#### Tests Added (44 new tests)

1. **discoverAgentFiles finds agents in .claude/agents/**
   - discovers .md files in .claude/agents/
   - assigns project source to .claude/agents/ files
   - includes full path to .claude/agents/ files

2. **discoverAgentFiles finds agents in .opencode/agents/**
   - discovers .md files in .opencode/agents/
   - assigns project source to .opencode/agents/ files
   - includes full path to .opencode/agents/ files

3. **discoverAgentFiles finds agents in .github/agents/**
   - discovers .md files in .github/agents/
   - assigns project source to .github/agents/ files
   - includes full path to .github/agents/ files

4. **discoverAgents finds all agents from all paths**
   - discovers agents from all four directories
   - parses Claude format frontmatter correctly
   - parses OpenCode format frontmatter correctly
   - parses GitHub format frontmatter correctly
   - parses Atomic format frontmatter correctly

5. **agents from all paths have correct sources**
   - agent from .claude/agents/ has project source
   - agent from .opencode/agents/ has project source
   - agent from .github/agents/ has project source
   - agent from .atomic/agents/ has atomic source

6. **discoverAgentFiles correctly identifies paths**
   - Tests for .claude/agents, .opencode/agents, .github/agents paths

7. **Sub-agent discovery with multiple agents per directory**
   - discovers all agents in .claude/agents/
   - discovers all agents in .github/agents/
   - discoverAgents finds all agents from multiple directories
   - all discovered agents have correct descriptions
   - all discovered agents have correct prompts

8. **Sub-agent discovery handles empty directories**
   - returns empty array for empty .claude/agents/
   - returns empty array for empty .github/agents/
   - discoverAgents still finds agents in non-empty directories
   - discoverAgents gracefully handles mix of empty and non-empty dirs

9. **Sub-agent discovery handles non-existent directories**
   - returns empty array for non-existent .claude/agents/
   - returns empty array for non-existent .opencode/agents/
   - returns empty array for non-existent .github/agents/
   - discoverAgents finds agents even when some directories don't exist

10. **Sub-agent discovery ignores non-.md files**
    - only discovers .md files in agent directories
    - ignores .txt files
    - ignores .json files
    - ignores .ts files
    - ignores hidden files

11. **Sub-agent discovery with name conflicts across directories**
    - handles duplicate names across directories
    - earlier discovery path takes precedence

#### Test Results
- All 242 tests in tests/ui/commands/agent-commands.test.ts pass (44 new tests added)
- No regressions detected

#### Files Modified
- tests/ui/commands/agent-commands.test.ts - Added 44 new tests for sub-agent discovery from multiple directories
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Unit test: Circular dependency detection

### Status: COMPLETED

Implemented comprehensive unit tests for circular dependency detection in the workflow resolution system (`resolveWorkflowRef`).

#### Tests Added (19 new tests)

1. **Resolution stack cleanup tests**
   - `resolveWorkflowRef clears resolution stack after successful resolution`
   - `resolveWorkflowRef clears resolution stack after failed resolution`

2. **Circular dependency detection behavior**
   - `resolveWorkflowRef(A) throws circular dependency error when A->B->A`
   - `error format includes arrow notation in chain`

3. **Non-circular dependencies work correctly**
   - `resolves leaf workflow without error`
   - `multiple resolutions of same workflow do not throw`
   - `resolution stack is cleared between independent resolutions`
   - `sequential resolution of different workflows works correctly`

4. **Resolution stack cleanup on error**
   - `resolution stack is cleared even when createWorkflow throws`
   - `resolution stack is cleared after workflow not found`

5. **Case-insensitive resolution stack tracking**
   - `resolution uses lowercase for stack tracking`
   - `case normalization in error message`

6. **Circular dependency error message format**
   - `error message format matches implementation`
   - `self-reference error includes workflow name twice`
   - `three-way cycle error includes all three workflow names`

7. **Integration: workflow registry and resolution stack interaction**
   - `hasWorkflow does not affect resolution stack`
   - `getWorkflowFromRegistry does not affect resolution stack`
   - `getWorkflowNames does not affect resolution stack`
   - `refreshWorkflowRegistry clears and reinitializes properly`

#### Implementation Details

The circular dependency detection is implemented in `src/ui/commands/workflow-commands.ts`:
- Uses a `resolutionStack` Set to track workflows currently being resolved
- Converts workflow names to lowercase for case-insensitive detection
- When a workflow is already in the stack, throws error with format:
  `Circular workflow dependency detected: workflow-a -> workflow-b -> workflow-a`
- The stack is always cleaned up in a `finally` block, even on errors

#### Test Results
- All 170 tests in tests/ui/commands/workflow-commands.test.ts pass (19 new tests added)
- No regressions detected

#### Files Modified
- tests/ui/commands/workflow-commands.test.ts - Expanded circular dependency detection tests from 2 to 19 tests
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Unit test: Workflow loading from multiple search paths

### Status: COMPLETED

Implemented comprehensive unit tests for workflow loading from multiple search paths (local `.atomic/workflows/` and global `~/.atomic/workflows/`).

#### Tests Added (18 new tests)

1. **discoverWorkflowFiles finds both local and global workflows**
   - `discovers workflows in local directory`
   - `discovers workflows in global directory`
   - `discovers workflows from both directories simultaneously`
   - `correctly marks source for local vs global paths`

2. **loadWorkflowsFromDisk loads both local and global workflows**
   - `loads workflows from both local and global directories`
   - `preserves workflow metadata from both directories`

3. **local workflows override global workflows with same name**
   - `local workflow takes precedence over global workflow with same name`
   - `local workflow overrides global even with different case in name`
   - `alias collision: local alias takes precedence over global workflow`

4. **invalid workflow files are skipped with warning**
   - `skips file without default export`
   - `skips file with non-function default export`
   - `skips file with syntax errors gracefully`
   - `continues loading valid workflows even when some are invalid`
   - `handles empty workflow directory gracefully`
   - `handles non-.ts files without error`

5. **edge cases for multi-path loading**
   - `handles missing local directory when global exists`
   - `handles missing global directory when local exists`
   - `handles both directories missing`

#### Test Results
- All 153 tests in tests/ui/commands/workflow-commands.test.ts pass (18 new tests added)
- No regressions detected

#### Files Modified
- tests/ui/commands/workflow-commands.test.ts - Added 18 new tests for multi-path workflow loading
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Implement debug reports accumulation in workflow state

### Status: COMPLETED

Implemented debugReports field accumulation in RalphWorkflowState for persisting debug reports across workflow iterations. Reports are accumulated using Reducers.concat and are available for inspection after workflow completes.

#### Changes Made

1. **Updated src/graph/nodes/ralph-nodes.ts**
   - Added `DebugReport` to the imports from `../types.ts`
   - Added `debugReports: DebugReport[]` field to RalphWorkflowState interface with documentation
   - Updated `isRalphWorkflowState()` type guard to check for `debugReports` as an array
   - Updated `createRalphWorkflowState()` to initialize `debugReports` as empty array
   - Updated `sessionToWorkflowState()` to preserve debugReports from session (with fallback to empty array)
   - Updated `workflowStateToSession()` to include debugReports in session

2. **Updated src/workflows/ralph-session.ts**
   - Added `DebugReport` import from `../graph/types.ts`
   - Added optional `debugReports?: DebugReport[]` field to RalphSession interface
   - Updated `createRalphSession()` to initialize debugReports (defaults to empty array)
   - Updated `isRalphSession()` type guard to accept debugReports (optional array field)

3. **Updated tests/graph/nodes/ralph-nodes.test.ts**
   - Added `debugReports: []` to `createTestState()` fixture
   - Added new "Debug Reports Accumulation" test suite with 11 tests:
     - RalphWorkflowState includes debugReports field
     - debugReports is initialized as empty array
     - debugReports can be set with debug reports
     - isRalphWorkflowState validates debugReports field
     - isRalphWorkflowState accepts debugReports as array
     - sessionToWorkflowState preserves debugReports from session
     - sessionToWorkflowState handles missing debugReports gracefully
     - workflowStateToSession includes debugReports
     - debugReports accumulates across multiple additions (simulated concat)
     - debugReports persists through session save and load cycle
     - debugReports available for inspection after workflow state round-trip

#### Test Results
- All 229 tests in tests/graph/nodes/ralph-nodes.test.ts pass (11 new tests added)
- All 77 tests in tests/graph/annotation.test.ts pass
- All 47 tests in tests/workflows/ralph-session.test.ts pass
- No regressions detected

#### Files Modified
- src/graph/nodes/ralph-nodes.ts - Added debugReports field and related updates
- src/workflows/ralph-session.ts - Added debugReports field to RalphSession
- tests/graph/nodes/ralph-nodes.test.ts - Added 11 new tests and fixture update
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Implement workflow telemetry for start, node transitions, completion events

### Status: COMPLETED

Implemented workflow telemetry to track workflow execution events including start, node transitions (enter/exit), completion, and errors.

#### Changes Made

1. **Added new WorkflowEventType values in src/telemetry/types.ts**
   - Added "workflow.start" for workflow start events
   - Added "workflow.complete" for workflow completion events
   - Added "workflow.error" for workflow error events
   - Added "workflow.node.enter" for node entry events
   - Added "workflow.node.exit" for node exit events with duration
   - Updated isWorkflowEventType type guard to include new event types

2. **Added WorkflowTelemetryConfig and WorkflowTracker interfaces in src/telemetry/graph-integration.ts**
   - WorkflowTelemetryConfig: Configuration for workflow telemetry (collector, trackNodes, additionalProperties)
   - WorkflowTracker: Interface with start(), nodeEnter(), nodeExit(), complete(), error() methods
   - Created trackWorkflowExecution() factory function
   - Created withWorkflowTelemetry() convenience wrapper for automatic tracking

3. **Integrated telemetry into GraphExecutor in src/graph/compiled.ts**
   - Added workflowName and telemetry options to ExecutionOptions interface
   - Tracks workflow.start at beginning of stream execution
   - Tracks workflow.node.enter before each node execution
   - Tracks workflow.node.exit after each node execution (with duration)
   - Tracks workflow.complete on successful completion (before final yield)
   - Tracks workflow.error and workflow.complete on failures/cancellation

#### Tests Added

1. **Updated tests/telemetry/types.test.ts** (1 new test, updated counts)
   - validates new workflow execution event types
   - Updated workflow events count from 8 to 13
   - Updated total event count from 33 to 38

2. **Added tests/telemetry/graph-integration.test.ts** (13 new tests)
   - trackWorkflowExecution: start(), nodeEnter(), nodeExit(), complete(), error() tests
   - withWorkflowTelemetry: success/error/tracker integration tests
   - Workflow Telemetry Integration test suite

3. **Added tests/graph/compiled.test.ts** (8 new tests)
   - emits workflow.start event when telemetry is enabled
   - emits workflow.node.enter and workflow.node.exit events for each node
   - emits workflow.complete event on successful completion
   - emits workflow.error and workflow.complete events on failure
   - does not emit telemetry events when telemetry option is not provided
   - node exit events include duration
   - workflow name is passed to start event
   - telemetry tracks cancellation as failure

#### Test Results
- All 47 tests in tests/graph/compiled.test.ts pass
- All 53 tests in tests/telemetry/graph-integration.test.ts pass
- All 41 tests in tests/telemetry/types.test.ts pass
- Build succeeds

#### Files Modified
- src/telemetry/types.ts - Added new workflow event types and updated type guard
- src/telemetry/graph-integration.ts - Added WorkflowTelemetryConfig, WorkflowTracker, trackWorkflowExecution(), withWorkflowTelemetry()
- src/graph/compiled.ts - Integrated telemetry tracking into GraphExecutor stream method
- tests/telemetry/types.test.ts - Updated tests for new event types
- tests/telemetry/graph-integration.test.ts - Added tests for workflow tracking functions
- tests/graph/compiled.test.ts - Added tests for GraphExecutor telemetry integration
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Add visual indicator for yolo mode vs feature-list mode

### Status: COMPLETED

Implemented visual mode indicator at the start of Ralph workflow execution to show whether the session is running in yolo (freestyle) mode or feature-list mode.

#### Changes Made

1. **Added mode display for new sessions in initRalphSessionNode()**
   - Location: src/graph/nodes/ralph-nodes.ts (lines 1497-1502)
   - After displaying "Started Ralph session: {uuid}", shows:
     - In yolo mode: `Mode: Freestyle (yolo)`
     - In feature-list mode: `Mode: Feature list (N features)` where N is the count

2. **Added mode display for resumed sessions**
   - Location: src/graph/nodes/ralph-nodes.ts (lines 1459-1464)
   - After displaying "Resuming Ralph session: {uuid}", shows the same mode indicators
   - Uses session.yolo and session.features.length for the display

3. **Refactored feature loading order**
   - Moved feature loading before the mode display to accurately show the count
   - Split the feature saving step to avoid duplicate loading

4. **Example output**:
   ```
   Started Ralph session: abc123-def456
   Mode: Feature list (5 features)
   ```
   or
   ```
   Started Ralph session: abc123-def456
   Mode: Freestyle (yolo)
   ```

#### Tests Added (7 new tests in tests/graph/nodes/ralph-nodes.test.ts)

- `displays 'Mode: Freestyle (yolo)' for yolo mode` - Verifies exact yolo mode message
- `displays 'Mode: Feature list (N features)' for feature-list mode` - Verifies message with feature count
- `displays correct count for single feature` - Verifies "1 features" is displayed
- `displays correct count for empty feature list` - Verifies "0 features" is displayed
- `displays mode indicator when resuming yolo session` - Verifies yolo mode on resume
- `displays mode indicator when resuming feature-list session` - Verifies feature count on resume
- `mode indicator appears after session ID in logs` - Verifies correct log ordering

#### Test Results
- All 218 tests in tests/graph/nodes/ralph-nodes.test.ts pass (7 new tests added)
- All 568 tests in tests/graph/ pass
- Build succeeds

#### Files Modified
- src/graph/nodes/ralph-nodes.ts - Added mode display in initRalphSessionNode() for both new and resumed sessions
- tests/graph/nodes/ralph-nodes.test.ts - Added 7 new tests for mode indicator display
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Display completed features count during Ralph execution

### Status: COMPLETED

Implemented UI feedback to show completed features count during Ralph workflow execution in feature-list mode.

#### Changes Made

1. **Added completed features count display in implementFeatureNode()**
   - Location: src/graph/nodes/ralph-nodes.ts (lines 804-808)
   - Displays `Features: {completed}/{total} completed` after status display
   - Only shown in feature-list mode (not in yolo mode)
   - Counts features with status "passing" as completed
   - Example output:
     ```
     Iteration 5/100
     Status: Running
     Features: 3/10 completed
     Implementing: Add User Authentication
     ```

2. **Implementation Details**
   - Filters features array for those with status "passing"
   - Uses total features count from features.length
   - Display logic: `console.log(\`Features: ${completedCount}/${totalCount} completed\`)`
   - Placed after status display and before yolo mode check
   - Conditionally skipped in yolo mode since there are no discrete features

#### Tests Added (4 new tests in tests/graph/nodes/ralph-nodes.test.ts)

- `displays completed features count with some features completed` - Verifies "Features: 2/4 completed" is logged when 2 of 4 features are passing
- `displays completed features count with zero features completed` - Verifies "Features: 0/3 completed" is logged when no features are passing
- `displays completed features count with all features completed` - Verifies "Features: 2/2 completed" is logged when all features are passing
- `does not display completed features count in yolo mode` - Verifies no "Features:" line is logged in yolo mode

#### Test Results
- All 195 tests in tests/graph/nodes/ralph-nodes.test.ts pass
- All 310 tests in Ralph-related test files pass
- No regressions detected

#### Files Modified
- src/graph/nodes/ralph-nodes.ts - Added completed features count display in implementFeatureNode()
- tests/graph/nodes/ralph-nodes.test.ts - Added 4 new tests for completed features display
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Display resume command on interrupt

### Status: COMPLETED

Verified and added tests for the resume command display functionality that was already implemented in handleInterrupt().

#### Functionality Verified

The implementation in `src/workflows/ralph-executor.ts` already includes:
1. `console.log("\nStopping Ralph execution...")` - Line 155
2. `console.log("Status: Paused")` - Line 170
3. `console.log("Paused Ralph session: ${this.sessionId}")` - Line 171
4. `console.log("Resume with: /ralph --resume ${this.sessionId}")` - Line 172

#### Tests Added (6 new tests in tests/workflows/ralph-executor.test.ts)

- `displays 'Paused Ralph session: {uuid}' on interrupt when session is set`
- `displays 'Resume with: /ralph --resume {uuid}' on interrupt when session is set`
- `displays 'Stopping Ralph execution...' on interrupt`
- `displays 'Status: Paused' on interrupt`
- `does not display resume command when session is not set`
- `resume command includes the correct session UUID format`

#### Test Results
- All 26 tests in tests/workflows/ralph-executor.test.ts pass
- All 172 tests in tests/workflows/ pass
- Build succeeds

#### Files Modified
- tests/workflows/ralph-executor.test.ts - Added 6 new tests for resume command display
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Display session status (running, paused, completed, failed)

### Status: COMPLETED

Implemented status indicator display throughout the Ralph workflow execution to show the current session status.

#### Changes Made

1. **Added formatSessionStatus() helper function**
   - Location: src/graph/nodes/ralph-nodes.ts (lines 690-712)
   - Converts internal status values to human-readable, capitalized strings
   - Maps: running -> "Running", paused -> "Paused", completed -> "Completed", failed -> "Failed"
   - Exported as `formatSessionStatus` and `RalphSessionStatus` type

2. **Added status display in implementFeatureNode()**
   - Location: src/graph/nodes/ralph-nodes.ts (line 764)
   - Displays `Status: Running` after the iteration count during active execution
   - Example output:
     ```
     Iteration 5/100
     Status: Running
     Implementing: Add User Authentication
     ```

3. **Added status display in checkCompletionNode()**
   - Shows `Status: Completed` when yolo mode completes (agent signals COMPLETE)
   - Shows `Status: Completed` when max iterations are reached
   - Shows `Status: Completed` when all features pass in feature-list mode

4. **Added status display in processYoloResult()**
   - Shows `Status: Completed` when yolo task completes or max iterations reached

5. **Added status display in processCreatePRResult()**
   - Shows `Status: Completed` after PR creation completes

6. **Added status display in ralph-executor.ts handleInterrupt()**
   - Location: src/workflows/ralph-executor.ts (line 170)
   - Shows `Status: Paused` when session is interrupted via Ctrl+C or Esc

#### Tests Added (11 new tests)

In tests/graph/nodes/ralph-nodes.test.ts:
- `formatSessionStatus` tests (4 tests):
  - formats 'running' status as 'Running'
  - formats 'paused' status as 'Paused'
  - formats 'completed' status as 'Completed'
  - formats 'failed' status as 'Failed'

- `implementFeatureNode` status display tests (2 tests):
  - displays session status as Running during active execution
  - displays session status in yolo mode

- `checkCompletionNode` status display tests (5 tests):
  - displays Completed status when yolo mode completes
  - displays Completed status when max iterations reached in yolo mode
  - displays Completed status when all features passing
  - displays Completed status when max iterations reached in feature-list mode
  - does not display status when workflow is continuing

#### Test Results
- All 191 tests in tests/graph/nodes/ralph-nodes.test.ts pass
- All 20 tests in tests/workflows/ralph-executor.test.ts pass
- All 707 tests in graph and workflow test suites pass
- Build succeeds

#### Files Modified
- src/graph/nodes/ralph-nodes.ts - Added formatSessionStatus(), RalphSessionStatus type, and status display calls
- src/workflows/ralph-executor.ts - Added status display on interrupt
- tests/graph/nodes/ralph-nodes.test.ts - Added 11 new tests for status display
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Display current feature being implemented in feature-list mode

### Status: COMPLETED

Implemented UI feedback to display the current feature being implemented during Ralph workflow execution.

#### Changes Made

1. **Added console output to implementFeatureNode()**
   - Location: src/graph/nodes/ralph-nodes.ts (lines 833-837)
   - Displays `Implementing: {feature.name}` when a pending feature is found
   - Shows the feature description on an indented line below (if different from name)
   - Example output:
     ```
     Implementing: Add User Authentication
       Implement OAuth2 flow for user login
     ```

2. **Description display logic**
   - Only shows description if it exists AND is different from the name
   - Prevents redundant output when name equals description
   - Description is indented with 2 spaces for visual hierarchy

#### Tests Added (3 new tests in tests/graph/nodes/ralph-nodes.test.ts)
- `displays current feature name when implementing` - Verifies "Implementing: {name}" is logged
- `displays feature description when different from name` - Verifies description shows on separate line
- `does not display description when same as name` - Verifies no duplicate output when name===description

#### Test Results
- All 177 tests in tests/graph/nodes/ralph-nodes.test.ts pass
- No regressions detected

#### Files Modified
- src/graph/nodes/ralph-nodes.ts - Added console.log for feature display
- tests/graph/nodes/ralph-nodes.test.ts - Added 3 new tests for display feature
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Update /help command to include Ralph workflow and sub-agent info

### Status: COMPLETED

Updated the /help command to include comprehensive documentation for sub-agents alongside the existing Ralph workflow documentation.

#### Changes Made

1. **Added "agent" to category order in /help output**
   - Position: Between "workflow" and "skill" categories
   - Label: "Sub-Agents"

2. **Added Sub-Agent Details section**
   - Shows when agent commands are registered
   - Lists each builtin agent with model information:
     - `/codebase-analyzer` (opus) - Deep code analysis and architecture review
     - `/codebase-locator` (haiku) - Find files and components quickly
     - `/codebase-pattern-finder` (sonnet) - Find similar implementations and patterns
     - `/codebase-online-researcher` (sonnet) - Research using web sources
     - `/codebase-research-analyzer` (sonnet) - Analyze research/ directory documents
     - `/codebase-research-locator` (haiku) - Find documents in research/ directory
     - `/debugger` (sonnet) - Debug errors and test failures
   - Custom agents show their description directly without hardcoded details

3. **Existing Ralph documentation preserved**
   - All flags documented: --yolo, --resume, --feature-list, --max-iterations
   - Interrupt instructions (Ctrl+C/Esc) still present

#### Tests Added (5 new tests in tests/ui/commands/builtin-commands.test.ts)
- shows Sub-Agents section when agent commands are registered
- shows all builtin agent details correctly
- shows custom agents without hardcoded details
- does not show Sub-Agents section when no agent commands registered
- groups agent commands under Sub-Agents category in command list

#### Test Results
- All 25 tests in builtin-commands.test.ts pass
- All 542 tests in tests/ui/commands/ pass
- Build succeeds

#### Files Modified
- src/ui/commands/builtin-commands.ts - Added agent category handling and Sub-Agent Details section
- tests/ui/commands/builtin-commands.test.ts - Added 5 new tests for sub-agents documentation
- research/feature-list.json - Updated passes to true for this feature

---

## 2026-02-03 - Feature Implementation: Remove hook-based Ralph loop implementation files

### Status: COMPLETED

Removed all hook-based Ralph loop implementation files since the graph engine is now the only execution mode.

#### Files Removed
- `.github/hooks/ralph-stop.ts` - Hook-based Ralph stop handler for GitHub Copilot
- `.github/scripts/ralph-loop.ts` - Hook-based Ralph loop setup script
- `.github/scripts/start-ralph-session.ts` - Hook-based session start handler
- `.github/scripts/cancel-ralph.ts` - Hook-based cancel script
- `.github/skills/ralph/` directory - Skills for hook-based Ralph (SKILL.md, ralph-loop.md, cancel-ralph.md)
- `plugins/ralph/` directory - Plugin files for hook-based Ralph (hooks.json, commands/*.md, plugin.json)
- `tests/ralph/ralph-loop-integration.test.ts` - Integration tests for hook-based loop
- `tests/ralph/start-ralph-session.test.ts` - Tests for start-ralph-session.ts
- `tests/ralph/ralph-loop-cli.test.ts` - CLI tests for ralph-loop.ts
- `tests/ralph/cancel-ralph.test.ts` - Tests for cancel-ralph.ts
- `tests/ralph/yaml-frontmatter.test.ts` - Tests for YAML frontmatter parsing

#### Files Modified
- `src/commands/ralph.ts` - Removed `ralphStop()` function and related utility functions (readStdin, parseFrontmatter, extractPromptText, testAllFeaturesPassing, extractPromiseText, fileExists, RALPH_STATE_FILE constant, TranscriptMessage and FeatureItem types)
- `src/cli.ts` - Removed `ralphStop` import and `ralph stop` subcommand

#### Files Kept (SDK-native workflow)
- `src/workflows/ralph.ts` - SDK-native workflow definition
- `src/workflows/ralph-session.ts` - Session management for SDK-native workflow
- `src/workflows/ralph-executor.ts` - Workflow executor
- `src/graph/nodes/ralph-nodes.ts` - Graph nodes for Ralph workflow
- `src/config/ralph.ts` - Configuration for Ralph workflow
- `tests/ralph/ralph-graph-engine.test.ts` - Tests for graph-based workflow (13 tests pass)

#### Test Results
- Build passes successfully
- All 13 Ralph graph engine tests pass
- Pre-existing test failures in cli-commander.test.ts are unrelated to this change

---

## 2026-02-03 - Feature Implementation: Remove explicit hooks module from src/

### Status: COMPLETED

Removed the explicit hooks module from src/sdk/ as hooks are now passthrough to the underlying SDKs.

#### Background
The hooks system was originally designed to provide a unified interface for registering event handlers across all coding agent SDKs (Claude, OpenCode, Copilot). However, this is no longer needed because:
- Claude SDK handles .claude/settings.json hooks natively
- OpenCode SDK handles hooks natively
- Copilot SDK handles hooks natively

#### Files Removed
- `src/sdk/hooks.ts` - HookManager unified hook system (605 lines)
- `src/sdk/claude-hooks.ts` - Claude-specific SDK hooks (214 lines)
- `src/sdk/opencode-hooks.ts` - OpenCode-specific SDK hooks (846 lines)
- `src/sdk/copilot-hooks.ts` - Copilot-specific SDK hooks (590 lines)
- `tests/sdk/hooks.test.ts` - HookManager tests
- `tests/sdk/claude-hooks.test.ts` - Claude hooks tests
- `tests/sdk/opencode-hooks.test.ts` - OpenCode hooks tests
- `tests/sdk/copilot-hooks.test.ts` - Copilot hooks tests

#### Files Modified
- `src/sdk/index.ts` - Removed all hooks-related exports, added note explaining hooks are passthrough to underlying SDKs

#### Removed Exports
- `HookManager`, `createHookManager`
- Hook type exports: `UnifiedHookEvent`, `HookContext`, `HookHandler`, `HookResult`, `HookEventData`, `HookEventDataMap`
- Event data types: `BaseHookEventData`, `HookSessionStartEventData`, `HookSessionEndEventData`, `HookSessionErrorEventData`, `ToolBeforeEventData`, `ToolAfterEventData`, `ToolErrorEventData`, `MessageBeforeEventData`, `MessageAfterEventData`, `PermissionRequestEventData`, `HookSubagentStartEventData`, `SubagentEndEventData`
- Claude hook exports: `createSessionEndTelemetryHook`, `createDefaultClaudeHooks`, `createSessionStartHook`, `createPreToolUseHook`, `createPostToolUseHook`
- Copilot hook exports: `createCopilotSessionStartHandler`, `createCopilotSessionEndHandler`, `createCopilotUserPromptHandler`, `registerDefaultCopilotHooks`, `createDefaultCopilotHooks`, `CopilotHookHandlers`
- OpenCode hook exports: `createOpenCodeSessionStartHandler`, `createOpenCodeSessionIdleHandler`, `createOpenCodeSessionDeletedHandler`, `createOpenCodeCommandExecuteHandler`, `createOpenCodeChatMessageHandler`, `registerDefaultOpenCodeHooks`, `createDefaultOpenCodeHooks`, `parseRalphState`, `writeRalphState`, `deleteRalphState`, `checkFeaturesPassing`, `checkCompletionPromise`, `normalizeCommandName`, `extractCommandsFromText`, `OpenCodeHookHandlers`, `OpenCodeHookContext`

#### Test Results
- Build passes successfully
- All 162 SDK tests pass (hooks tests removed)
- All tests pass (2962 pass, 17 fail - pre-existing failures unrelated to hooks)

---

## 2026-02-03 - Feature Implementation: Define RalphWorkflowState interface in graph/annotation.ts

### Status: COMPLETED

Implemented the `RalphWorkflowState` interface in `src/graph/annotation.ts` for the Ralph autonomous feature implementation workflow.

#### Implementation Details
- **Location**: src/graph/annotation.ts (lines 422-543)
- **Interface Fields**:
  - Base state fields: `executionId`, `lastUpdated`, `outputs`
  - Workflow fields: `researchDoc`, `specDoc`, `specApproved`, `featureList`, `currentFeature`, `allFeaturesPassing`, `contextWindowUsage`, `iteration`, `prUrl`, `debugReports`
  - Ralph-specific fields: `ralphSessionId`, `ralphSessionDir`, `yolo`, `yoloPrompt`, `yoloComplete`, `maxIterations`, `shouldContinue`, `prBranch`, `completedFeatures`, `sourceFeatureListPath`, `maxIterationsReached`

#### Added Exports
- `RalphWorkflowState` type
- `RalphStateAnnotation` annotation schema
- `createRalphState()` factory function
- `updateRalphState()` state update function
- `isRalphWorkflowState()` type guard

#### Tests Added (27 new tests in tests/graph/annotation.test.ts)
- RalphStateAnnotation field tests (3 tests)
- createRalphState tests (8 tests)
- updateRalphState tests (6 tests)
- isRalphWorkflowState tests (6 tests)
- Type inference tests (4 tests)

#### Test Results
- All 77 tests in tests/graph/annotation.test.ts pass
- All 524 tests in tests/graph/ pass

#### Files Modified
- src/graph/annotation.ts - Added RalphWorkflowState interface, annotation schema, factory functions, and type guard
- src/graph/index.ts - Added exports for RalphWorkflowState, RalphStateAnnotation, createRalphState, updateRalphState, isRalphWorkflowState
- tests/graph/annotation.test.ts - Added 27 new tests
- research/feature-list.json - Updated passes to true

---

## 2026-02-03 - Feature Verification: Define CommandDefinition interface in registry.ts

### Status: VERIFIED - Already Implemented

The CommandDefinition interface was already properly defined in src/ui/commands/registry.ts with all required fields.

#### Implementation Details
- **Location**: src/ui/commands/registry.ts (lines 107-120)
- **Interface Fields**:
  - `name: string` - Primary command name (without leading slash)
  - `description: string` - Human-readable description
  - `category: CommandCategory` - Command category for grouping
  - `execute: (args, context) => CommandResult | Promise<CommandResult>` - Function to execute the command
  - `aliases?: string[]` - Alternative names for the command
  - `hidden?: boolean` - Whether to hide from autocomplete list

#### Test Results
- All 35 tests in tests/ui/commands/registry.test.ts pass
- Tests cover command registration, lookup, search, and execution

#### Files Verified
- src/ui/commands/registry.ts - Contains complete CommandDefinition interface
- tests/ui/commands/registry.test.ts - Contains comprehensive tests for the interface

---

## 2026-02-03 - Feature Implementation: Wire handleAskUserQuestion to human_input_required event

### Completed
- Added `human_input_required` to `EventType` union in src/sdk/types.ts
  - Now includes all 11 event types including the new workflow graph event

- Added new SDK types:
  - `HumanInputOption` interface - Option structure for human_input_required events (label, description)
  - `HumanInputRequiredEventData` interface - Event data structure with requestId, question, header, options, nodeId, respond callback
  - Updated `EventDataMap` to include mapping for `human_input_required` event type

- Added askUserQuestion handler wiring in src/ui/index.ts:
  - Added `askUserQuestionHandler: OnAskUserQuestion | null` to `ChatUIState` interface
  - Initialized `askUserQuestionHandler: null` in state initialization
  - Created `registerAskUserQuestionHandler` callback that stores handler in state
  - Added subscription for `human_input_required` events in `subscribeToToolEvents()`
  - Event handler transforms event data to AskUserQuestionEventData format and calls registered handler
  - Added cleanup for the subscription in the unsubscribe function
  - Passed `registerAskUserQuestionHandler` to ChatApp props

- Added exports:
  - Exported `OnAskUserQuestion` type from src/ui/index.ts
  - Exported `HumanInputOption`, `HumanInputRequiredEventData`, `PermissionOption`, `PermissionRequestedEventData` from src/sdk/index.ts

### Test Results
- Added 8 new tests for human_input_required event wiring in tests/ui/chat.test.ts:
  - event listener receives human_input_required event data
  - event handler transforms event data to AskUserQuestionEventData format
  - event handler does not call askUserQuestionHandler if required fields are missing
  - event listener is set up during subscription
  - event listener is cleaned up on unsubscribe
  - registered handler is called with correct event data
  - options array is passed through correctly
  - optional header field is handled correctly

- Added 3 new tests for human_input_required event type in tests/sdk/types.test.ts:
  - includes all expected event types (updated from 9 to 11)
  - creates human_input_required event
  - creates human_input_required event without optional fields

- All tests pass:
  - tests/ui/chat.test.ts: 130 pass
  - tests/sdk/types.test.ts: 31 pass

### Files Modified
- src/sdk/types.ts - Added human_input_required to EventType, HumanInputOption, HumanInputRequiredEventData interfaces, updated EventDataMap
- src/sdk/index.ts - Added new type exports
- src/ui/index.ts - Added askUserQuestionHandler state, registration callback, event subscription, ChatApp prop
- tests/ui/chat.test.ts - Added 8 new tests
- tests/sdk/types.test.ts - Added 3 new tests

---

## 2026-02-03 - Feature Implementation: handleAskUserQuestion() in chat.tsx

### Completed
- Added `OnAskUserQuestion` callback type in src/ui/chat.tsx
  - Accepts `AskUserQuestionEventData` parameter from askUserNode
  - Type: `(eventData: AskUserQuestionEventData) => void`

- Added new ChatAppProps fields:
  - `registerAskUserQuestionHandler?: (handler: OnAskUserQuestion) => void` - Registration callback for askUserNode events
  - `onWorkflowResumeWithAnswer?: (requestId: string, answer: string | string[]) => void` - Callback to resume workflow with user's answer

- Added `askUserQuestionRequestIdRef` ref to store the requestId for response correlation

- Implemented `handleAskUserQuestion` callback:
  - Stores requestId in ref for response correlation
  - Converts `AskUserQuestionEventData` to `UserQuestion` format
  - Uses header or defaults to "Question"
  - Maps options using label as value (since AskUserOption only has label/description)
  - Shows question dialog via `handleHumanInputRequired`

- Added registration effect hook for `registerAskUserQuestionHandler`

- Updated `handleQuestionAnswer` to handle askUserNode responses:
  - Checks if `askUserQuestionRequestIdRef.current` is set
  - Clears the ref after processing
  - If `workflowState.workflowActive && onWorkflowResumeWithAnswer`:
    - Calls `onWorkflowResumeWithAnswer(requestId, answer.selected)` for workflow mode
  - Otherwise (standalone agent mode):
    - Gets session via `getSession()`
    - Sends answer through `session.send()` with array values joined by comma
  - Updated useCallback dependencies

- Imported `AskUserQuestionEventData` type from `../graph/index.ts`

### Tests Added (14 new tests)
- handleAskUserQuestion tests:
  - AskUserQuestionEventData has required fields
  - AskUserQuestionEventData with optional header
  - AskUserQuestionEventData with options array
  - conversion to UserQuestion format uses header or default
  - conversion preserves options with label as value
  - empty options array produces empty UserQuestion options

- handleAskUserQuestion response flow tests:
  - workflow mode calls onWorkflowResumeWithAnswer
  - standalone mode calls session.send
  - array answer is joined with comma for session.send
  - no action when session is null in standalone mode

- ChatAppProps with askUserQuestion handlers tests:
  - ChatAppProps includes registerAskUserQuestionHandler
  - ChatAppProps includes onWorkflowResumeWithAnswer
  - both handlers can be used together

- OnAskUserQuestion callback type tests:
  - accepts AskUserQuestionEventData parameter

### Test Results
- All chat.test.ts tests pass (122 tests, up from 108)
- All UI commands tests pass (621 tests)

### Files Modified
- src/ui/chat.tsx - Added handleAskUserQuestion callback, new props, updated handleQuestionAnswer
- tests/ui/chat.test.ts - Added 14 new tests for handleAskUserQuestion

---

## 2026-02-03 - Feature Implementation: askUserNode with human_input_required event

### Completed
- Added `"ask_user"` to NodeType enum in src/graph/types.ts
  - New node type specifically for explicit human-in-the-loop questions
  - Distinct from legacy `"wait"` type

- Defined AskUserOptions interface in src/graph/nodes.ts
  - `question: string` - The question to ask the user
  - `header?: string` - Short label for UI display
  - `options?: AskUserOption[]` - Structured options for user choice

- Defined AskUserOption interface
  - `label: string` - Display label for the option
  - `description: string` - Detailed description

- Defined AskUserNodeConfig interface for node configuration
  - `id: NodeId` - Unique identifier
  - `options: AskUserOptions | ((state) => AskUserOptions)` - Static or dynamic options
  - `name?: string` - Human-readable name
  - `description?: string` - Node description

- Defined AskUserWaitState interface for state extension
  - `__waitingForInput?: boolean` - Wait flag
  - `__waitNodeId?: string` - Node ID waiting for input
  - `__askUserRequestId?: string` - Request correlation ID

- Defined AskUserQuestionEventData interface for event data
  - `requestId: string` - UUID for correlating responses
  - `question: string` - The question
  - `header?: string` - Optional header
  - `options?: AskUserOption[]` - Optional structured options
  - `nodeId: string` - The asking node's ID

- Implemented askUserNode() function
  - Creates node with type `"ask_user"`
  - Generates unique requestId using `crypto.randomUUID()`
  - Emits `human_input_required` signal with full event data
  - Sets `__waitingForInput: true` in state
  - Sets `__waitNodeId` to node id in state
  - Sets `__askUserRequestId` for response correlation
  - Calls `ctx.emit()` when available
  - Supports both static and function-based options

- Updated src/graph/index.ts exports
  - Added type exports: AskUserOption, AskUserOptions, AskUserNodeConfig, AskUserWaitState, AskUserQuestionEventData
  - Added value export: askUserNode

### Tests Added (14 new tests)
- askUserNode tests:
  - creates node with correct type and id
  - uses provided name and description
  - emits human_input_required signal with question
  - generates unique requestId using crypto.randomUUID()
  - sets __waitingForInput to true in state update
  - sets __waitNodeId to node id in state update
  - sets __askUserRequestId in state update
  - includes options array in signal data
  - uses options function with state
  - calls emit function when available
  - works without emit function
  - handles empty options array
  - handles missing optional fields
  - generates different requestIds for each execution

### Test Results
- All nodes.test.ts tests pass (95 tests, up from 81)
- All graph tests pass (497 tests)

### Files Modified
- src/graph/types.ts - Added "ask_user" to NodeType enum
- src/graph/nodes.ts - Added AskUserOptions, AskUserNodeConfig, AskUserWaitState, AskUserQuestionEventData interfaces and askUserNode() function
- src/graph/index.ts - Added new type and value exports
- tests/graph/nodes.test.ts - Added 14 new tests for askUserNode

---

## 2026-02-03 - Feature Implementation: Update subgraphNode() to accept workflow name string

### Completed
- Updated SubgraphNodeConfig interface in src/graph/nodes.ts
  - Added CompiledSubgraph<TSubState> interface for typed subgraph execution
  - Added SubgraphRef<TSubState> type as union of CompiledSubgraph | string
  - Updated subgraph field to accept SubgraphRef (either compiled graph or workflow name string)
  - Added comprehensive JSDoc documentation for the new type

- Implemented WorkflowResolver dependency injection pattern
  - Added WorkflowResolver type for workflow name resolution function
  - Added globalWorkflowResolver module-level variable
  - Added setWorkflowResolver() to set the global resolver
  - Added getWorkflowResolver() to get the current resolver
  - This pattern avoids circular dependencies between nodes.ts and workflow-commands.ts

- Updated subgraphNode() function to handle string workflow references
  - If subgraph is a string, resolve via globalWorkflowResolver
  - Throws clear error if no resolver is set: "Cannot resolve workflow \"{name}\": No workflow resolver set"
  - Throws "Workflow not found: {name}" if resolver returns null
  - If subgraph is a CompiledGraph, use directly (existing behavior)
  - Both paths execute the subgraph and return result

- Integrated workflow resolver with workflow-commands.ts
  - Added import for setWorkflowResolver in workflow-commands.ts
  - Added initializeWorkflowResolver() function to set resolveWorkflowRef as the global resolver
  - Updated registerWorkflowCommands() to call initializeWorkflowResolver() automatically
  - Exported initializeWorkflowResolver and resolveWorkflowRef from index.ts

- Updated src/graph/index.ts exports
  - Added CompiledSubgraph, SubgraphRef, WorkflowResolver type exports
  - Added setWorkflowResolver, getWorkflowResolver value exports

### Tests Added
- subgraphNode with string workflow reference tests (9 tests):
  - setWorkflowResolver sets the global resolver
  - getWorkflowResolver returns null when not set
  - resolves workflow by name and executes it
  - throws error when no workflow resolver is set
  - throws error when workflow is not found
  - stores resolved subgraph result in outputs without mapper
  - uses inputMapper when resolving workflow by name
  - compiled graph still works when string is not provided
  - accepts any workflow name string

### Test Results
- All nodes.test.ts tests pass (81 tests, up from 72)
- All graph tests pass (483 tests)
- All workflow-commands tests pass (122 tests)
- All UI commands tests pass (513 tests)

### Files Modified
- src/graph/nodes.ts - Added CompiledSubgraph, SubgraphRef types, WorkflowResolver pattern, updated subgraphNode()
- src/graph/index.ts - Added new type and value exports
- src/ui/commands/workflow-commands.ts - Added initializeWorkflowResolver(), updated registerWorkflowCommands()
- src/ui/commands/index.ts - Added initializeWorkflowResolver and resolveWorkflowRef exports
- tests/graph/nodes.test.ts - Added 9 new tests for string workflow reference

---

## 2026-02-03 - Feature Implementation: Workflow Registry and Resolution

### Completed
- Implemented workflowRegistry Map for workflow lookup in workflow-commands.ts
  - Created module-level workflowRegistry: Map<string, WorkflowMetadata>
  - Added registryInitialized flag to track initialization state
  - Created initializeRegistry() function to populate registry from getAllWorkflows()
  - Registry includes both built-in and dynamically loaded workflows
  - Registry maps both primary names and aliases (case-insensitive)

- Implemented resolutionStack Set for circular dependency detection
  - Created module-level resolutionStack: Set<string>
  - Used to track current workflow resolution chain
  - Cleared after each resolution completes (in finally block)

- Implemented resolveWorkflowRef() function for subgraph workflow lookup
  - Function signature: resolveWorkflowRef(name: string): CompiledGraph<BaseState> | null
  - Checks resolutionStack for circular dependency before resolution
  - Throws Error with dependency chain on circular reference: 'Circular workflow dependency detected: A -> B -> A'
  - Adds name to resolutionStack during resolution
  - Looks up workflow in registry via getWorkflowFromRegistry()
  - Creates workflow with defaultConfig
  - Removes name from resolutionStack in finally block (always cleans up)
  - Returns compiled graph or null if not found

- Added helper functions:
  - getWorkflowFromRegistry(name): Find workflow by name/alias
  - hasWorkflow(name): Check if workflow exists in registry
  - getWorkflowNames(): Get array of all workflow names
  - refreshWorkflowRegistry(): Clear and reinitialize registry

### Tests Added
- loadWorkflowsFromDisk tests (5 tests):
  - returns empty array when no workflow files exist
  - loads workflow from valid .ts file
  - skips workflow file without default export function
  - uses filename as name when module.name is not defined
  - provides default description when not exported

- getAllWorkflows tests (2 tests):
  - returns array including built-in workflows
  - workflows have required fields

- workflow loading priority tests (3 tests):
  - local workflows marked with source 'local'
  - built-in workflows marked with source 'builtin'
  - deduplicates workflows by name (case-insensitive)

- workflowRegistry tests (9 tests):
  - getWorkflowFromRegistry finds workflow by name
  - getWorkflowFromRegistry finds workflow by alias
  - getWorkflowFromRegistry is case-insensitive
  - getWorkflowFromRegistry returns undefined for unknown workflow
  - hasWorkflow returns true for registered workflow
  - hasWorkflow returns false for unknown workflow
  - hasWorkflow is case-insensitive
  - getWorkflowNames returns array of workflow names
  - refreshWorkflowRegistry reinitializes registry

- resolveWorkflowRef tests (5 tests):
  - resolves workflow by name
  - resolves workflow by alias
  - is case-insensitive
  - returns null for unknown workflow
  - applies default config when resolving

- circular dependency detection tests (2 tests):
  - resolveWorkflowRef clears resolution stack after successful resolution
  - resolveWorkflowRef clears resolution stack after failed resolution

### Test Results
- All workflow-commands tests pass (122 tests)
- Total expect() calls: 299

### Features Marked as Passing
- discoverWorkflowFiles() to find .ts files in search paths
- loadWorkflowsFromDisk() to dynamically import workflow modules
- Validate required exports in custom workflow files
- Local workflow override of global workflows
- Create workflowRegistry Map for workflow lookup
- Implement resolveWorkflowRef() for subgraph workflow lookup
- Create resolutionStack Set for circular dependency detection
- Implement circular dependency detection in resolveWorkflowRef()

### Files Modified
- src/ui/commands/workflow-commands.ts - Added workflowRegistry, resolutionStack, resolveWorkflowRef(), and helper functions
- tests/ui/commands/workflow-commands.test.ts - Added 26 new tests for workflow registry and resolution

---

## 2026-02-03 - Feature Implementation: CUSTOM_WORKFLOW_SEARCH_PATHS Constant

### Completed
- Defined and exported CUSTOM_WORKFLOW_SEARCH_PATHS constant in workflow-commands.ts
  - Array of paths to search for custom workflow definitions
  - `.atomic/workflows` for project-local workflows (highest priority)
  - `~/.atomic/workflows` for user-global workflows (lower priority)
  - Added comprehensive JSDoc documentation with examples
- Added expandPath() helper function to resolve ~ paths
  - Expands ~/path to $HOME/path
  - Expands ~path to $HOME/path
  - Resolves relative paths from process.cwd()
- Updated discoverWorkflowFiles() function
  - Now uses CUSTOM_WORKFLOW_SEARCH_PATHS constant instead of hardcoded paths
  - Uses expandPath() for proper path expansion
  - Added detailed documentation about search order

### Tests Added
- CUSTOM_WORKFLOW_SEARCH_PATHS tests:
  - is exported as an array
  - has correct number of paths (2)
  - contains .atomic/workflows for project-local workflows
  - contains ~/.atomic/workflows for user-global workflows
  - local path comes before global path (higher priority)
  - local path is first element
  - global path is second element
- discoverWorkflowFiles tests:
  - returns empty array when no workflow directories exist
  - discovers .ts files in local workflow directory
  - marks local workflows with source 'local'
  - ignores non-.ts files
  - returns absolute paths

### Test Results
- All workflow-commands tests pass (96 tests)
- All UI commands tests pass (487 tests)

### Files Modified
- src/ui/commands/workflow-commands.ts - Added CUSTOM_WORKFLOW_SEARCH_PATHS constant and expandPath() helper
- tests/ui/commands/workflow-commands.test.ts - Added CUSTOM_WORKFLOW_SEARCH_PATHS and discoverWorkflowFiles tests

---

## 2026-02-03 - Feature Implementation: Remove /reject Command Registration

### Completed
- Removed /reject command from builtin-commands.ts
  - Removed rejectCommand export and definition
  - Removed from builtinCommands array (now 5 commands)
  - Updated file header comment
- Updated /status command message
  - Changed from "Use `/reject <feedback>` to revise or continue manually" to "Review the spec and continue manually or revise."
- Updated index.ts
  - Removed rejectCommand from exports
  - Updated comment: "Built-in commands (help, status, theme, clear, compact)"
- Updated cli.ts
  - Removed /reject from slash commands help text
- Updated chat.ts
  - Removed /reject command handler block
  - Updated help message to remove /reject
  - Updated approval prompt from mentioning /reject to "Review the spec and type any message to continue, or revise manually."
  - Simplified approval callback logic (no longer checking for "reject" in message)

### Tests Updated
- tests/ui/commands/builtin-commands.test.ts
  - Removed rejectCommand import
  - Removed entire rejectCommand test suite
  - Updated builtinCommands array test (5 commands instead of 6)
  - Removed rejectCommand from "contains all built-in commands" test
  - Updated "registers all built-in commands" test to verify reject is NOT registered
  - Removed "no" alias test (was rejectCommand alias)
  - Updated idempotent test (size 5 instead of 6)
  - Updated pending approval state test to not expect /reject in message
- tests/ui/commands/index.test.ts
  - Updated expect for globalRegistry.has("reject") to be false
  - Added expect for globalRegistry.has("compact") to be true

### Test Results
- All UI commands tests pass (492 tests)
- All builtin-commands tests pass (37 tests)
- All index tests pass (31 tests)

### Files Modified
- src/ui/commands/builtin-commands.ts - Removed /reject command
- src/ui/commands/index.ts - Removed rejectCommand export
- src/cli.ts - Removed /reject from help text
- src/commands/chat.ts - Removed /reject handling, updated messages
- tests/ui/commands/builtin-commands.test.ts - Removed rejectCommand tests
- tests/ui/commands/index.test.ts - Updated reject registration test

---

## 2026-02-03 - Feature Implementation: Remove /approve Command Registration

### Completed
- Removed /approve command from builtin-commands.ts
  - Removed approveCommand export and definition
  - Removed from builtinCommands array
  - Updated command count from 7 to 6
- Updated /status command message to remove /approve reference
  - Changed "Use `/approve` or `/reject <feedback>` to continue" to "Use `/reject <feedback>` to revise or continue manually"
- Updated index.ts
  - Removed approveCommand from exports
  - Updated comment to remove /approve from list
- Updated cli.ts
  - Removed /approve from slash commands help text
- Updated chat.ts
  - Removed /approve command handler block
  - Updated help message to remove /approve
  - Changed approval prompt from "Type `/approve` to proceed or `/reject`" to "Type `/reject <feedback>` to request revisions or continue manually."
  - Updated approval callback logic: any input continues workflow, explicit "reject" rejects

### Tests Updated
- tests/ui/commands/builtin-commands.test.ts
  - Removed approveCommand import
  - Removed entire approveCommand test suite
  - Updated builtinCommands array test (6 commands instead of 7)
  - Removed "ok" and "yes" alias tests (those were approveCommand aliases)
  - Updated registerBuiltinCommands idempotent test (size 6 instead of 7)
  - Updated pending approval state test to not expect /approve in message
- tests/ui/commands/index.test.ts
  - Removed expect for globalRegistry.has("approve")
  - Added note: "/approve removed - spec approval is now manual before workflow"

### Test Results
- All UI commands tests pass (498 tests)
- All builtin-commands tests pass (43 tests)
- All index tests pass (31 tests)

### Files Modified
- src/ui/commands/builtin-commands.ts - Removed /approve command
- src/ui/commands/index.ts - Removed approveCommand export
- src/cli.ts - Removed /approve from help text
- src/commands/chat.ts - Removed /approve handling, updated messages
- tests/ui/commands/builtin-commands.test.ts - Removed approveCommand tests
- tests/ui/commands/index.test.ts - Removed approve registration test

---

## 2026-02-03 - Feature Implementation: Remove /ralph:ralph-help and Integrate into /help

### Completed
- Verified /ralph:ralph-help command already removed from SKILL_DEFINITIONS
- Updated /help command to include Ralph workflow documentation when /ralph is registered
- Added comprehensive Ralph workflow help section with:
  - Usage examples for default mode, --yolo mode, and --resume
  - Option documentation for --feature-list and --max-iterations
  - Interrupt instructions (Ctrl+C or Esc to pause)
  - Resume instructions with session UUID
- Fixed pre-existing test failures in builtin-commands.test.ts
  - Updated expected command count from 6 to 7 (includes compactCommand)
  - Added compactCommand to import and array containment tests

### Tests Added
- helpCommand shows Ralph workflow documentation when /ralph is registered
- helpCommand does not show Ralph documentation when /ralph is not registered

### Test Results
- All UI commands tests pass (502 tests)
- All builtin-commands tests pass (47 tests)
- All skill-commands tests pass (107 tests)

### Files Modified
- src/ui/commands/builtin-commands.ts - Updated /help to include Ralph workflow docs
- tests/ui/commands/builtin-commands.test.ts - Fixed command count, added Ralph help tests

## 2026-02-02 - Feature Implementation: BuiltinSkill Interface

### Completed
- Created BuiltinSkill interface in skill-commands.ts
  - Added name: string field (skill name without leading slash)
  - Added description: string field (human-readable description)
  - Added aliases?: string[] field (alternative command names)
  - Added prompt: string field (full prompt content with $ARGUMENTS support)
  - Added hidden?: boolean field (hide from autocomplete)
  - Exported the interface for use in other modules

### Tests Added
- Added test suite for BuiltinSkill interface:
  - Valid BuiltinSkill has all required fields
  - BuiltinSkill supports optional aliases
  - BuiltinSkill supports optional hidden flag
  - BuiltinSkill with all optional fields

### Test Results
- All skill-commands tests pass (37 tests)
- Note: Some pre-existing test failures in other modules (builtin-commands count mismatch)

### Files Modified
- src/ui/commands/skill-commands.ts - Added BuiltinSkill interface
- tests/ui/commands/skill-commands.test.ts - Added BuiltinSkill tests

## 2026-02-02 - Feature Implementation: Commit Skill as Builtin

### Completed
- Added BUILTIN_SKILLS array with commit skill in skill-commands.ts
  - Set name to 'commit'
  - Set description to 'Create well-formatted commits with conventional commit format'
  - Set aliases to ['ci']
  - Embedded full conventional commit prompt with git commands and guidelines
  - Included $ARGUMENTS placeholder for user arguments
- Added getBuiltinSkill() helper function to look up builtin skills by name/alias
- Updated createSkillCommand() to check builtin skills first before disk-based loading
- Priority order: builtin skill > disk-based skill > slash command fallback

### Tests Added
- BUILTIN_SKILLS tests:
  - contains commit skill with correct fields
  - commit skill has $ARGUMENTS placeholder
  - commit skill includes conventional commit guidelines
  - commit skill includes git commands
  - all builtin skills have required fields
- getBuiltinSkill tests:
  - finds builtin skill by name
  - finds builtin skill by alias
  - is case-insensitive
  - returns undefined for non-builtin skill
  - returns undefined for unknown skill
- builtin skill execution tests:
  - commit command uses embedded prompt
  - commit command expands $ARGUMENTS with provided args

### Test Results
- All skill-commands tests pass (49 tests)

### Files Modified
- src/ui/commands/skill-commands.ts - Added BUILTIN_SKILLS array and getBuiltinSkill()
- tests/ui/commands/skill-commands.test.ts - Added BUILTIN_SKILLS and execution tests

## 2026-02-02 - Feature Implementation: Research-Codebase Skill as Builtin

### Completed
- Added research-codebase skill to BUILTIN_SKILLS array in skill-commands.ts
  - Set name to 'research-codebase'
  - Set description to 'Document codebase as-is with research directory for historical context'
  - Set aliases to ['research']
  - Embedded comprehensive prompt for analyzing and documenting codebase
  - Included instructions for creating research/ directory artifacts:
    - research/architecture.md - High-level architecture documentation
    - research/directory-structure.md - Directory structure mapping
    - research/tech-stack.md - Technology stack catalog
    - research/entry-points.md - Entry points and execution flows
    - research/patterns.md - Coding patterns and conventions
    - research/data-models.md - Data structures and schemas
    - research/dependencies.md - External dependencies analysis
  - Included $ARGUMENTS placeholder for focused analysis (e.g., specific modules)
  - Added guidelines for objective, factual documentation

### Tests Added
- BUILTIN_SKILLS tests:
  - contains research-codebase skill with correct fields
  - research-codebase skill has $ARGUMENTS placeholder
  - research-codebase skill includes research directory structure
  - research-codebase skill includes documentation guidelines
- getBuiltinSkill tests:
  - finds research-codebase builtin skill by name
  - finds research-codebase builtin skill by alias
- builtin skill execution tests:
  - research-codebase command uses embedded prompt
  - research-codebase command expands $ARGUMENTS with provided args

### Test Results
- All skill-commands tests pass (57 tests)
- Note: Pre-existing test failures in builtin-commands module remain (count mismatch)

### Files Modified
- src/ui/commands/skill-commands.ts - Added research-codebase to BUILTIN_SKILLS array
- tests/ui/commands/skill-commands.test.ts - Added research-codebase tests

## 2026-02-02 - Feature Implementation: Create-Spec Skill as Builtin

### Completed
- Added create-spec skill to BUILTIN_SKILLS array in skill-commands.ts
  - Set name to 'create-spec'
  - Set description to 'Generate technical specification from research'
  - Set aliases to ['spec']
  - Embedded comprehensive prompt for generating technical specifications
  - Included instructions for creating research/spec.md with sections:
    - Overview - Feature summary and goals
    - Technical Approach - Design decisions and alternatives
    - Component Design - Module interfaces and dependencies
    - Data Model Changes - Types and schema changes
    - API Changes - Endpoints and breaking changes
    - Integration Points - System integration details
    - Error Handling - Error scenarios and recovery
    - Testing Strategy - Test requirements
    - Implementation Order - Suggested sequence
    - Open Questions - Unresolved decisions
  - Referenced research directory artifacts as input sources
  - Included $ARGUMENTS placeholder for feature/refactor description

### Tests Added
- BUILTIN_SKILLS tests:
  - contains create-spec skill with correct fields
  - create-spec skill has $ARGUMENTS placeholder
  - create-spec skill includes spec structure sections
  - create-spec skill references research directory
- getBuiltinSkill tests:
  - finds create-spec builtin skill by name
  - finds create-spec builtin skill by alias
- builtin skill execution tests:
  - create-spec command uses embedded prompt
  - create-spec command expands $ARGUMENTS with provided args

### Test Results
- All skill-commands tests pass (65 tests)

### Files Modified
- src/ui/commands/skill-commands.ts - Added create-spec to BUILTIN_SKILLS array
- tests/ui/commands/skill-commands.test.ts - Added create-spec tests

## 2026-02-02 - Feature Implementation: Create-Feature-List Skill as Builtin

### Completed
- Added create-feature-list skill to BUILTIN_SKILLS array in skill-commands.ts
  - Set name to 'create-feature-list'
  - Set description to 'Break spec into implementable tasks'
  - Set aliases to ['features']
  - Embedded comprehensive prompt for creating feature-list.json
  - Included JSON schema for feature list format with fields:
    - category (functional, refactor, test, documentation, ui, e2e)
    - description (brief description of the feature)
    - steps (ordered list of implementation steps)
    - passes (boolean for test status, initially false)
  - Added instructions for creating research/progress.txt
  - Included feature breakdown guidelines and ordering rules
  - Included $ARGUMENTS placeholder for focused breakdown

### Tests Added
- BUILTIN_SKILLS tests:
  - contains create-feature-list skill with correct fields
  - create-feature-list skill has $ARGUMENTS placeholder
  - create-feature-list skill includes JSON schema
  - create-feature-list skill includes feature categories
- getBuiltinSkill tests:
  - finds create-feature-list builtin skill by name
  - finds create-feature-list builtin skill by alias
- builtin skill execution tests:
  - create-feature-list command uses embedded prompt
  - create-feature-list command expands $ARGUMENTS with provided args

### Test Results
- All skill-commands tests pass (73 tests)

### Files Modified
- src/ui/commands/skill-commands.ts - Added create-feature-list to BUILTIN_SKILLS array
- tests/ui/commands/skill-commands.test.ts - Added create-feature-list tests

## 2026-02-02 - Feature Implementation: Implement-Feature Skill as Builtin

### Completed
- Added implement-feature skill to BUILTIN_SKILLS array in skill-commands.ts
  - Set name to 'implement-feature'
  - Set description to 'Implement next feature from list'
  - Set aliases to ['impl']
  - Embedded comprehensive prompt for implementing features from feature-list.json
  - Included complete implementation process:
    - Load feature list and identify next feature
    - Review feature context (description, steps, category)
    - Implement each step
    - Write tests for new functionality
    - Update feature status (passes: true) after completion
  - Added feature categories explanation (functional, refactor, test, documentation, ui, e2e)
  - Included progress tracking instructions for research/progress.txt
  - Included error handling guidelines
  - Included $ARGUMENTS placeholder for specific feature targeting

### Tests Added
- BUILTIN_SKILLS tests:
  - contains implement-feature skill with correct fields
  - implement-feature skill has $ARGUMENTS placeholder
  - implement-feature skill includes implementation process
  - implement-feature skill includes feature categories
- getBuiltinSkill tests:
  - finds implement-feature builtin skill by name
  - finds implement-feature builtin skill by alias
- builtin skill execution tests:
  - implement-feature command uses embedded prompt
  - implement-feature command expands $ARGUMENTS with provided args

### Test Results
- All skill-commands tests pass (81 tests)

### Files Modified
- src/ui/commands/skill-commands.ts - Added implement-feature to BUILTIN_SKILLS array
- tests/ui/commands/skill-commands.test.ts - Added implement-feature tests

## 2026-02-02 - Feature Implementation: Create-GH-PR Skill as Builtin

### Completed
- Added create-gh-pr skill to BUILTIN_SKILLS array in skill-commands.ts
  - Set name to 'create-gh-pr'
  - Set description to 'Push and create pull request'
  - Set aliases to ['pr']
  - Embedded comprehensive prompt for creating GitHub PRs
  - Included complete PR workflow:
    - Check repository state (branch, remote, uncommitted changes)
    - Commit changes if needed
    - Push to remote with upstream tracking
    - Create PR using gh CLI
  - Added PR template format with Summary, Changes, Testing sections
  - Included gh CLI commands reference (create, view, list PRs)
  - Added guidelines for PR title, description, and branch naming
  - Included error handling for common issues
  - Included $ARGUMENTS placeholder for PR title

### Tests Added
- BUILTIN_SKILLS tests:
  - contains create-gh-pr skill with correct fields
  - create-gh-pr skill has $ARGUMENTS placeholder
  - create-gh-pr skill includes gh CLI commands
  - create-gh-pr skill includes PR template format
- getBuiltinSkill tests:
  - finds create-gh-pr builtin skill by name
  - finds create-gh-pr builtin skill by alias
- builtin skill execution tests:
  - create-gh-pr command uses embedded prompt
  - create-gh-pr command expands $ARGUMENTS with provided args

### Test Results
- All skill-commands tests pass (89 tests)

### Files Modified
- src/ui/commands/skill-commands.ts - Added create-gh-pr to BUILTIN_SKILLS array
- tests/ui/commands/skill-commands.test.ts - Added create-gh-pr tests

## 2026-02-02 - Feature Implementation: Explain-Code Skill as Builtin

### Completed
- Added explain-code skill to BUILTIN_SKILLS array in skill-commands.ts
  - Set name to 'explain-code'
  - Set description to 'Explain code functionality in detail'
  - Set aliases to ['explain']
  - Embedded comprehensive prompt for explaining code functionality
  - Included explanation structure covering:
    - Overview - What the code does
    - Structure Analysis - Components and organization
    - Control Flow - Execution order and paths
    - Data Flow - Inputs, transformations, outputs
    - Key Algorithms - Patterns and complexity
    - Error Handling - Detection and recovery
    - Side Effects - External state modifications
    - Dependencies - External libraries used
  - Supported input types:
    - File Path (e.g., src/utils/parser.ts)
    - File Path with Line Range (e.g., src/utils/parser.ts:10-50)
    - Function or Class Name
    - Code Selection
    - Conceptual Query
  - Included $ARGUMENTS placeholder for code path/selection
  - Added guidelines for clear, thorough explanations

### Tests Added
- BUILTIN_SKILLS tests:
  - contains explain-code skill with correct fields
  - explain-code skill has $ARGUMENTS placeholder
  - explain-code skill includes explanation structure
  - explain-code skill includes input types
- getBuiltinSkill tests:
  - finds explain-code builtin skill by name
  - finds explain-code builtin skill by alias
- builtin skill execution tests:
  - explain-code command uses embedded prompt
  - explain-code command expands $ARGUMENTS with provided args

### Test Results
- All skill-commands tests pass (97 tests)

### Files Modified
- src/ui/commands/skill-commands.ts - Added explain-code to BUILTIN_SKILLS array
- tests/ui/commands/skill-commands.test.ts - Added explain-code tests

## 2026-02-02 - Feature Implementation: registerBuiltinSkills() and $ARGUMENTS expansion

### Completed
- Created `registerBuiltinSkills()` function in skill-commands.ts
  - Iterates over BUILTIN_SKILLS array
  - Creates CommandDefinition for each builtin skill
  - Sets category to 'skill'
  - Implements execute handler that directly uses embedded prompt
  - Checks if command already exists before registering (idempotent)
  - Calls globalRegistry.register() for each skill
- Created `createBuiltinSkillCommand()` factory function
  - Takes BuiltinSkill with embedded prompt
  - Returns CommandDefinition with execute handler
  - Uses embedded prompt directly (no disk lookup needed)
- Created `builtinSkillCommands` array
  - Maps BUILTIN_SKILLS through createBuiltinSkillCommand()
  - Exported for testing and direct access
- Updated `registerSkillCommands()` to call `registerBuiltinSkills()` first
  - Builtin skills take priority over legacy disk-based skills
  - Legacy skills only registered if not already registered

### $ARGUMENTS Expansion
- Execute handler expands $ARGUMENTS placeholder using expandArguments()
- Empty args replaced with '[no arguments provided]'
- Uses regex /\$ARGUMENTS/g for global replacement
- Passes expanded prompt to context.sendMessage()

### Tests Added
- builtinSkillCommands tests:
  - has correct number of commands
  - all commands have skill category
  - each command has matching builtin skill
  - commands use embedded prompts directly
- registerBuiltinSkills tests:
  - registers all builtin skills
  - registers builtin skill aliases
  - is idempotent
  - registered commands use embedded prompts
  - expands $ARGUMENTS in registered commands
  - replaces empty args with placeholder
- registerSkillCommands tests:
  - builtin skills take priority over legacy skills

### Test Results
- All skill-commands tests pass (108 tests)

### Files Modified
- src/ui/commands/skill-commands.ts - Added registerBuiltinSkills(), createBuiltinSkillCommand(), builtinSkillCommands
- tests/ui/commands/skill-commands.test.ts - Added builtinSkillCommands and registerBuiltinSkills tests

## 2026-02-02 - Refactor: Remove disk-based skill loading

### Completed
- Removed SKILL_SEARCH_PATHS constant (was searching .claude/commands, .opencode/command, .github/commands)
- Removed loadSkillPrompt() function that loaded skill prompts from disk
- Removed stripFrontmatter() function that stripped YAML frontmatter from markdown files
- Removed fs imports (existsSync, readFileSync) and path import (join)
- Simplified createSkillCommand() to:
  - First check for builtin skill with embedded prompt
  - Fallback to sending slash command to agent's native skill system
  - No more intermediate disk-based loading
- Updated module docstring to reflect new architecture
- Updated exports to remove loadSkillPrompt and stripFrontmatter

### Rationale
- All core skills are now defined as builtins with embedded prompts
- Disk-based skill loading was legacy fallback that's no longer needed
- Reduces file system dependencies
- Simplifies the skill command execution flow

### Test Results
- All skill-commands tests pass (108 tests)

### Files Modified
- src/ui/commands/skill-commands.ts - Removed disk-based skill loading code

## 2026-02-02 - Feature Implementation: AgentDefinition Interface

### Completed
- Created new file src/ui/commands/agent-commands.ts
- Defined AgentSource type: 'builtin' | 'project' | 'user' | 'atomic'
- Defined AgentModel type: 'sonnet' | 'opus' | 'haiku'
- Defined AgentDefinition interface with fields:
  - name: string (unique identifier, becomes slash command)
  - description: string (when to use this agent)
  - tools?: string[] (allowed tools, inherits all if omitted)
  - model?: AgentModel (model override)
  - prompt: string (system prompt content)
  - source: AgentSource (for conflict resolution)
- Added comprehensive JSDoc documentation for all types and fields
- Exported all types and interfaces

### Tests Added
- AgentDefinition interface tests:
  - valid AgentDefinition has all required fields
  - AgentDefinition supports optional tools array
  - AgentDefinition supports optional model field
  - AgentDefinition with all optional fields
  - AgentDefinition without optional fields
- AgentSource type tests (builtin, project, user, atomic)
- AgentModel type tests (sonnet, opus, haiku)
- Example agent definition tests:
  - codebase-analyzer agent definition is valid
  - codebase-locator agent definition is valid
  - debugger agent definition is valid

### Test Results
- All agent-commands tests pass (15 tests)

### Files Created
- src/ui/commands/agent-commands.ts - AgentDefinition interface and related types
- tests/ui/commands/agent-commands.test.ts - Tests for AgentDefinition interface

## 2026-02-02 - Feature Implementation: AgentFrontmatter Interface

### Completed
- Added AgentFrontmatter interface in agent-commands.ts
  - Interface handles different SDK frontmatter formats for agent markdown files
  - Added name?: string field (optional, can be derived from filename in some SDKs)
  - Added description: string field (required by all SDKs)
  - Added tools?: string[] | Record<string, boolean> field
    - Claude: array of tool names
    - OpenCode: Record<string, boolean> with tool names as keys
    - Copilot: array of tool names
  - Added model?: string field
    - Claude: "sonnet" | "opus" | "haiku"
    - OpenCode: "provider/model" format (e.g., "anthropic/claude-3-sonnet")
    - Copilot: string model identifier
  - Added mode?: "subagent" | "primary" field (OpenCode-specific)
  - Added comprehensive JSDoc documentation with examples for each SDK format
  - Exported the interface

### Tests Added
- AgentFrontmatter interface tests:
  - Claude format with tools as string array
  - OpenCode format with tools as Record<string, boolean>
  - OpenCode format with mode field
  - frontmatter with optional name field omitted
  - frontmatter with only required description field
  - Copilot format with tools as string array
  - frontmatter with all optional fields

### Test Results
- All agent-commands tests pass (22 tests)
- Note: Pre-existing test failures in builtin-commands module remain (count mismatch)

### Files Modified
- src/ui/commands/agent-commands.ts - Added AgentFrontmatter interface
- tests/ui/commands/agent-commands.test.ts - Added AgentFrontmatter tests

## 2026-02-02 - Feature Implementation: Agent Discovery Path Constants

### Completed
- Added AGENT_DISCOVERY_PATHS constant in agent-commands.ts
  - Project-local directories to search for agent definition files
  - Includes: `.claude/agents`, `.opencode/agents`, `.github/agents`, `.atomic/agents`
  - Paths are relative to project root
  - Files in these directories override user-global agents
- Added GLOBAL_AGENT_PATHS constant in agent-commands.ts
  - User-global directories to search for agent definition files
  - Includes: `~/.claude/agents`, `~/.opencode/agents`, `~/.copilot/agents`, `~/.atomic/agents`
  - Use ~ for home directory expansion
  - Project-local agents take precedence over user-global
- Exported both constants for use by discoverAgents()

### Tests Added
- AGENT_DISCOVERY_PATHS tests:
  - contains .claude/agents path
  - contains .opencode/agents path
  - contains .github/agents path
  - contains .atomic/agents path
  - has 4 project-local paths
  - all paths are relative (no leading slash or tilde)
- GLOBAL_AGENT_PATHS tests:
  - contains ~/.claude/agents path
  - contains ~/.opencode/agents path
  - contains ~/.copilot/agents path
  - contains ~/.atomic/agents path
  - has 4 user-global paths
  - all paths start with ~ for home directory expansion

### Test Results
- All agent-commands tests pass (34 tests)

### Files Modified
- src/ui/commands/agent-commands.ts - Added AGENT_DISCOVERY_PATHS and GLOBAL_AGENT_PATHS constants
- tests/ui/commands/agent-commands.test.ts - Added path constant tests

## 2026-02-02 - Feature Implementation: discoverAgents() and parseAgentFrontmatter()

### Completed
- Implemented discoverAgents() function in agent-commands.ts
  - Async function returning Promise<AgentDefinition[]>
  - Scans AGENT_DISCOVERY_PATHS for project-local .md files
  - Scans GLOBAL_AGENT_PATHS for user-global .md files (with ~ expansion)
  - Parses YAML frontmatter and body content from each file
  - Uses parseAgentFrontmatter() to normalize across SDK formats
  - Determines source based on which path matched
  - Project-local agents override user-global agents with same name
  - Returns array of AgentDefinition objects

- Implemented parseAgentFrontmatter() function
  - Normalizes frontmatter from Claude, OpenCode, and Copilot formats
  - Extracts name from frontmatter.name or derives from filename
  - Extracts description with fallback default
  - Normalizes tools: converts Record<string, boolean> to string[] of enabled tools
  - Normalizes model: maps 'provider/model' format to 'sonnet'|'opus'|'haiku'
  - Returns normalized AgentDefinition

- Implemented helper functions:
  - parseMarkdownFrontmatter(): Parses YAML frontmatter from markdown content
    - Handles simple key-value pairs, arrays (Claude format), and objects (OpenCode format)
    - Returns frontmatter object and body content
  - normalizeModel(): Converts various model formats to AgentModel type
  - normalizeTools(): Converts tool formats to string array
  - expandTildePath(): Expands ~ in paths to home directory
  - determineAgentSource(): Determines agent source based on discovery path
  - discoverAgentFilesInPath(): Discovers .md files in a single directory
  - discoverAgentFiles(): Discovers all agent files from all search paths
  - parseAgentFile(): Parses a single agent file into AgentDefinition
  - shouldAgentOverride(): Determines if new agent should override existing based on source priority

- Added DiscoveredAgentFile interface for tracking discovered files with metadata

### Tests Added (49 new tests)
- parseMarkdownFrontmatter tests:
  - parses simple frontmatter with string values
  - parses frontmatter with array values (Claude format)
  - parses frontmatter with object values (OpenCode format)
  - parses frontmatter with boolean values
  - parses frontmatter with numeric values
  - returns null for content without frontmatter
  - returns null for invalid frontmatter format
  - handles empty body after frontmatter
  - handles multiline body content

- normalizeModel tests:
  - returns undefined for undefined input
  - returns direct match for sonnet/opus/haiku (case-insensitive)
  - extracts model from OpenCode format (anthropic/claude-3-*)
  - returns undefined for unknown model

- normalizeTools tests:
  - returns undefined for undefined input
  - passes through array format (Claude/Copilot)
  - converts object format to array (OpenCode)
  - returns empty array when all tools are disabled

- parseAgentFrontmatter tests:
  - creates AgentDefinition with all fields
  - uses filename as name when not in frontmatter
  - uses default description when not in frontmatter
  - normalizes OpenCode tools format
  - normalizes OpenCode model format
  - trims body content

- Path utilities tests:
  - expandTildePath: expands ~/, standalone ~, preserves absolute/relative paths
  - determineAgentSource: correctly identifies user, atomic, project sources
  - shouldAgentOverride: correct priority ordering

- discoverAgentFilesInPath tests:
  - discovers .md files in directory
  - ignores non-.md files
  - assigns correct source to discovered files
  - returns empty array for non-existent directory

- parseAgentFile tests:
  - parses agent with full frontmatter
  - parses agent without frontmatter
  - returns null for non-existent file

- discoverAgents tests:
  - discovers agents from local directories
  - returns array of AgentDefinition objects

### Test Results
- All agent-commands tests pass (83 tests)
- Note: Pre-existing test failures in builtin-commands and tool-result modules remain

### Files Modified
- src/ui/commands/agent-commands.ts - Added imports, interfaces, and all implementation functions
- tests/ui/commands/agent-commands.test.ts - Added comprehensive tests for all new functions

## 2026-02-02 - Feature Implementation: BUILTIN_AGENTS with codebase-analyzer

### Completed
- Created BUILTIN_AGENTS array in 