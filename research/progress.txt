# Sub-Agent Tree View Investigation Progress

## Task #1: Trace task tool → sub-agent spawn → tree view event flow (COMPLETED)

### Date: 2025-07-23

### Summary
End-to-end trace of the sub-agent event flow from Task tool invocation through tree view rendering.
Identified 4 concrete issues preventing the tree view from appearing.

### Architecture Overview

Two parallel paths exist for sub-agent tracking:

**Path 1: SDK Events (index.ts lines 555-629)**
- SDK fires `subagent.start` / `subagent.complete` events
- Claude: Via SubagentStart/SubagentStop hooks (registered in buildNativeHooks)
- OpenCode: Via emitEvent() calls (lines 495-506)
- Copilot: Via event type mapping (subagent.started → subagent.start, etc.)
- Handler creates ParallelAgent → calls state.parallelAgentHandler(state.parallelAgents)
- Handler REPLACES entire React state via setParallelAgents(agents)

**Path 2: spawnSubagent (chat.tsx lines 2810-2851)**
- Creates ParallelAgent directly → setParallelAgents(prev => [...prev, agent])
- Delegates to SubagentSessionManager for independent session execution
- onStatusUpdate callback updates individual agent status
- This path APPENDS to React state (not replaces)

### Identified Issues

**Issue 1 (CRITICAL): spawnSubagent() doesn't update parallelAgentsRef**
- File: src/ui/chat.tsx, line 2832
- spawnSubagent() calls setParallelAgents(prev => [...prev, agent]) but does NOT update parallelAgentsRef.current
- parallelAgentsRef is ONLY updated by registerParallelAgentHandler (line 2218)
- handleComplete uses parallelAgentsRef.current (line 2774) to check for active agents
- Result: handleComplete won't defer completion → clears agents prematurely → tree disappears

**Issue 2 (HIGH): State replacement conflict between paths**
- index.ts path: state.parallelAgentHandler(state.parallelAgents) → REPLACES entire state
- spawnSubagent path: setParallelAgents(prev => [...prev]) → APPENDS to state
- If both fire, index.ts handler overwrites agents added by spawnSubagent
- Fix: index.ts handler should use functional update or merge with existing state

**Issue 3 (HIGH): SubagentGraphBridge never initialized**
- setSubagentBridge() is NEVER called in the codebase
- getSubagentBridge() always returns null
- subagentNode() and parallelSubagentNode() in nodes.ts always throw errors
- Graph-based workflows cannot spawn sub-agents

**Issue 4 (MEDIUM): Agent commands use sendSilentMessage() instead of spawnSubagent()**
- File: src/ui/commands/agent-commands.ts, line 1514
- Agent commands (/codebase-locator, /codebase-analyzer, etc.) use context.sendSilentMessage()
- This runs in the SAME context window, NOT a separate one
- No ParallelAgent is created → no tree view entry
- To run in separate context windows with tree view, should use spawnSubagent()

### Tree View Rendering Conditions
- ParallelAgentsTree only renders for the LAST message (chat.tsx line 4494)
- Shows live parallelAgents if non-empty, falls back to message.parallelAgents (baked data)
- Both sources must have length > 0 for tree to appear (lines 1410-1422)

### Key Files
- src/ui/index.ts: Central orchestrator, SDK event subscriptions
- src/ui/chat.tsx: Main chat component, spawnSubagent, state management
- src/ui/subagent-session-manager.ts: Independent session spawning
- src/ui/components/parallel-agents-tree.tsx: Tree view component
- src/graph/subagent-bridge.ts: Graph bridge (never initialized)
- src/graph/nodes.ts: Graph nodes for sub-agents
- src/sdk/claude-client.ts: Claude hook registration
- src/sdk/opencode-client.ts: OpenCode event emission
- src/sdk/copilot-client.ts: Copilot event mapping

### Next Steps
- Task #4: Initialize SubagentGraphBridge (Issue #3)
- Task #5: Ensure ParallelAgentsTree renders for isolated context window agents

## Task #2: Identify SubagentSessionManager callback disconnects (COMPLETED)
## Task #3: Wire SubagentSessionManager onStatusUpdate to chat UI (COMPLETED)

### Date: 2025-07-23

### Root Cause Identified
The `parallelAgentsRef` (used by `handleComplete` for synchronous active-agent checks) was only updated
via `registerParallelAgentHandler` (SDK events path). Two other paths that modify parallel agents state
did NOT update the ref:

1. `spawnSubagent()` (chat.tsx line ~2876): Added agents via `setParallelAgents(prev => [...prev, agent])`
   without updating `parallelAgentsRef.current`
2. `onStatusUpdate` callback (chat.tsx lines ~2303-2306): Updated agent status via `setParallelAgents(prev => prev.map(...))`
   without updating `parallelAgentsRef.current`

### Consequence
When `handleComplete` checked `parallelAgentsRef.current.some(a => running/pending)` (line 2774),
it wouldn't see agents from the `spawnSubagent()` path → didn't defer completion → cleared agents
prematurely → tree view disappeared.

### Fix Applied
Both `setParallelAgents` calls now update `parallelAgentsRef.current` inside the updater function:

**spawnSubagent() fix (chat.tsx ~line 2886):**
```typescript
setParallelAgents((prev) => {
  const next = [...prev, parallelAgent];
  parallelAgentsRef.current = next;
  return next;
});
```

**onStatusUpdate fix (chat.tsx ~line 2304):**
```typescript
onStatusUpdate: (agentId, update) => {
  setParallelAgents((prev) => {
    const next = prev.map((a) => (a.id === agentId ? { ...a, ...update } : a));
    parallelAgentsRef.current = next;
    return next;
  });
},
```

### Tests Added
3 new tests in `src/ui/__tests__/spawn-subagent-integration.test.ts`:
- "spawnSubagent path: ref syncs when adding agent"
- "onStatusUpdate path: ref syncs when updating agent status"
- "ref desync prevented: handleComplete defers correctly with active agents"

All 10 tests pass (7 existing + 3 new).
