# Progress Log - Update/Uninstall Commands Implementation

## 2026-01-21 - Feature 1: getBinaryInstallDir() and getBinaryPath() helpers

### Completed
- Added `getBinaryInstallDir()` function to `src/utils/config-path.ts`
  - Returns `~/.local/bin` on Unix, `%USERPROFILE%\.local\bin` on Windows
  - Supports `ATOMIC_INSTALL_DIR` environment variable override
- Added `getBinaryPath()` function to `src/utils/config-path.ts`
  - Returns full path to binary: `<install_dir>/atomic` (Unix) or `<install_dir>/atomic.exe` (Windows)
- Created comprehensive unit tests in `tests/config-path.test.ts`
  - 15 new tests covering all functions in config-path.ts
  - Tests for platform detection, environment variable handling, path construction
  - All 227 tests pass (212 existing + 15 new)

### Files Modified
- `src/utils/config-path.ts` - Added two new exported functions
- `tests/config-path.test.ts` - New test file

### Notes
- Functions follow the same patterns as existing `getBinaryDataDir()` function
- Platform detection reuses existing `isWindows()` from detect.ts
- Ready for use by update and uninstall commands

---

## 2026-01-21 - Feature 2: Download utilities (src/utils/download.ts)

### Completed
- Created `src/utils/download.ts` with GitHub release and download utilities
- Implemented `ReleaseInfo` interface for GitHub release data
- Implemented `getLatestRelease()` to fetch latest release from GitHub API
  - Handles GITHUB_TOKEN environment variable for rate limit mitigation
  - Provides clear error messages for 403 (rate limit) and 404 (not found)
- Implemented `getReleaseByVersion()` to fetch a specific version's release info
- Implemented `downloadFile()` with progress callback support
  - Streams data in chunks to track download progress
  - Uses Bun.write for efficient file writing
- Implemented `parseChecksums()` to parse checksums.txt format
- Implemented `verifyChecksum()` using Bun.CryptoHasher for SHA256 verification
- Implemented `getBinaryFilename()` for platform-specific binary names
  - Supports linux-x64, linux-arm64, darwin-x64, darwin-arm64, windows-x64
- Implemented `getConfigArchiveFilename()` for platform-specific config archives
  - Returns .tar.gz for Unix, .zip for Windows
- Implemented `getDownloadUrl()` and `getChecksumsUrl()` to build GitHub release asset URLs

### Files Created
- `src/utils/download.ts` - New download utilities module
- `tests/download.test.ts` - Comprehensive unit tests (27 tests)

### Test Results
- All 254 tests pass (227 existing + 27 new download tests)
- Tests cover:
  - Platform detection (getBinaryFilename, getConfigArchiveFilename)
  - URL construction (getDownloadUrl, getChecksumsUrl)
  - Checksum parsing and verification
  - Edge cases (empty content, malformed lines, case sensitivity)

### Notes
- Network-dependent functions (getLatestRelease, downloadFile) are not tested with real network calls in unit tests
- These would be covered by integration tests
- Module exports all necessary types and functions for use by update command

---

## 2026-01-21 - Feature 3: Update command (src/commands/update.ts)

### Completed
- Created `src/commands/update.ts` with full update command implementation
- Implemented `isNewerVersion()` for semver comparison with proper major/minor/patch handling
- Added installation type detection with helpful error messages:
  - npm/bun installs: Shows package manager update commands
  - Source installs: Shows git pull instructions
  - Binary installs: Proceeds with self-update
- Implemented `--check` flag to check for updates without installing
- Implemented `--yes` flag to skip confirmation prompt
- Implemented `--target-version` flag to install specific versions
- Implemented download with progress indicator using downloadFile()
- Implemented checksum verification for binary and config archive
- Implemented `replaceBinaryUnix()` using atomic rename with chmod 755
- Implemented `replaceBinaryWindows()` using rename strategy for locked executables
- Implemented `extractConfig()` using tar (Unix) or PowerShell Expand-Archive (Windows)
- Added installation verification by running --version on new binary
- Added temp directory cleanup on success or failure
- Added helpful error messages for:
  - GitHub API rate limiting (suggests GITHUB_TOKEN)
  - Version not found (links to releases page)
  - Network failures

### Files Created
- `src/commands/update.ts` - Update command implementation
- `tests/update.test.ts` - Unit tests for isNewerVersion() (17 tests)

### Test Results
- All 271 tests pass (254 existing + 17 new update tests)
- Tests cover:
  - Major version differences
  - Minor version differences
  - Patch version differences
  - Equal versions
  - 'v' prefix handling
  - Edge cases (leading zeros, 0.x versions, precedence)

### Notes
- The update command is fully implemented but not yet integrated into CLI entry point
- Integration will be done in a separate feature (CLI integration)
- Uses all the utilities created in previous features (download.ts, config-path.ts)

---

## 2026-01-21 - Feature 4: Uninstall command (src/commands/uninstall.ts)

### Completed
- Created `src/commands/uninstall.ts` with full uninstall command implementation
- Added installation type detection with helpful error messages:
  - npm/bun installs: Shows package manager uninstall commands
  - Source installs: Shows manual removal instructions
  - Binary installs: Proceeds with self-uninstall
- Implemented `--dry-run` flag to preview files that would be removed
- Implemented `--yes` flag to skip confirmation prompt
- Implemented `--keep-config` flag to preserve data directory
- Displays list of files/directories before removal
- Removes data directory (~/.local/share/atomic or %LOCALAPPDATA%\atomic)
- Implements Unix binary self-deletion using unlink()
- Implements Windows binary self-deletion using rename to .delete strategy
- Generates and displays PATH cleanup instructions for:
  - Bash (~/.bashrc, ~/.bash_profile)
  - Zsh (~/.zshrc)
  - Fish (~/.config/fish/config.fish)
  - PowerShell ($PROFILE)
  - Windows Environment Variables GUI
- Handles permission errors gracefully with platform-specific guidance

### Files Created
- `src/commands/uninstall.ts` - Uninstall command implementation
- `tests/uninstall.test.ts` - Unit tests (10 tests)

### Test Results
- All 281 tests pass (271 existing + 10 new uninstall tests)
- Tests cover:
  - getPathCleanupInstructions() output
  - Platform-specific shell instructions
  - Module exports

### Notes
- The uninstall command is fully implemented but not yet integrated into CLI entry point
- Integration will be done in the next feature (CLI integration)
- On Windows, running executable cannot be deleted, so it's renamed to .delete

---
Next feature: Integrate update and uninstall commands into CLI entry point
