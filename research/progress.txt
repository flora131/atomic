# Sub-Agent Tree View Investigation Progress

## Task #1: Trace task tool → sub-agent spawn → tree view event flow (COMPLETED)

### Date: 2025-07-23

### Summary
End-to-end trace of the sub-agent event flow from Task tool invocation through tree view rendering.
Identified 4 concrete issues preventing the tree view from appearing.

### Architecture Overview

Two parallel paths exist for sub-agent tracking:

**Path 1: SDK Events (index.ts lines 555-629)**
- SDK fires `subagent.start` / `subagent.complete` events
- Claude: Via SubagentStart/SubagentStop hooks (registered in buildNativeHooks)
- OpenCode: Via emitEvent() calls (lines 495-506)
- Copilot: Via event type mapping (subagent.started → subagent.start, etc.)
- Handler creates ParallelAgent → calls state.parallelAgentHandler(state.parallelAgents)
- Handler REPLACES entire React state via setParallelAgents(agents)

**Path 2: spawnSubagent (chat.tsx lines 2810-2851)**
- Creates ParallelAgent directly → setParallelAgents(prev => [...prev, agent])
- Delegates to SubagentSessionManager for independent session execution
- onStatusUpdate callback updates individual agent status
- This path APPENDS to React state (not replaces)

### Identified Issues

**Issue 1 (CRITICAL): spawnSubagent() doesn't update parallelAgentsRef**
- File: src/ui/chat.tsx, line 2832
- spawnSubagent() calls setParallelAgents(prev => [...prev, agent]) but does NOT update parallelAgentsRef.current
- parallelAgentsRef is ONLY updated by registerParallelAgentHandler (line 2218)
- handleComplete uses parallelAgentsRef.current (line 2774) to check for active agents
- Result: handleComplete won't defer completion → clears agents prematurely → tree disappears

**Issue 2 (HIGH): State replacement conflict between paths**
- index.ts path: state.parallelAgentHandler(state.parallelAgents) → REPLACES entire state
- spawnSubagent path: setParallelAgents(prev => [...prev]) → APPENDS to state
- If both fire, index.ts handler overwrites agents added by spawnSubagent
- Fix: index.ts handler should use functional update or merge with existing state

**Issue 3 (HIGH): SubagentGraphBridge never initialized**
- setSubagentBridge() is NEVER called in the codebase
- getSubagentBridge() always returns null
- subagentNode() and parallelSubagentNode() in nodes.ts always throw errors
- Graph-based workflows cannot spawn sub-agents

**Issue 4 (MEDIUM): Agent commands use sendSilentMessage() instead of spawnSubagent()**
- File: src/ui/commands/agent-commands.ts, line 1514
- Agent commands (/codebase-locator, /codebase-analyzer, etc.) use context.sendSilentMessage()
- This runs in the SAME context window, NOT a separate one
- No ParallelAgent is created → no tree view entry
- To run in separate context windows with tree view, should use spawnSubagent()

### Tree View Rendering Conditions
- ParallelAgentsTree only renders for the LAST message (chat.tsx line 4494)
- Shows live parallelAgents if non-empty, falls back to message.parallelAgents (baked data)
- Both sources must have length > 0 for tree to appear (lines 1410-1422)

### Key Files
- src/ui/index.ts: Central orchestrator, SDK event subscriptions
- src/ui/chat.tsx: Main chat component, spawnSubagent, state management
- src/ui/subagent-session-manager.ts: Independent session spawning
- src/ui/components/parallel-agents-tree.tsx: Tree view component
- src/graph/subagent-bridge.ts: Graph bridge (never initialized)
- src/graph/nodes.ts: Graph nodes for sub-agents
- src/sdk/claude-client.ts: Claude hook registration
- src/sdk/opencode-client.ts: OpenCode event emission
- src/sdk/copilot-client.ts: Copilot event mapping

### Next Steps
- Task #4: Initialize SubagentGraphBridge (Issue #3)
- Task #5: Ensure ParallelAgentsTree renders for isolated context window agents

## Task #2: Identify SubagentSessionManager callback disconnects (COMPLETED)
## Task #3: Wire SubagentSessionManager onStatusUpdate to chat UI (COMPLETED)

### Date: 2025-07-23

### Root Cause Identified
The `parallelAgentsRef` (used by `handleComplete` for synchronous active-agent checks) was only updated
via `registerParallelAgentHandler` (SDK events path). Two other paths that modify parallel agents state
did NOT update the ref:

1. `spawnSubagent()` (chat.tsx line ~2876): Added agents via `setParallelAgents(prev => [...prev, agent])`
   without updating `parallelAgentsRef.current`
2. `onStatusUpdate` callback (chat.tsx lines ~2303-2306): Updated agent status via `setParallelAgents(prev => prev.map(...))`
   without updating `parallelAgentsRef.current`

### Consequence
When `handleComplete` checked `parallelAgentsRef.current.some(a => running/pending)` (line 2774),
it wouldn't see agents from the `spawnSubagent()` path → didn't defer completion → cleared agents
prematurely → tree view disappeared.

### Fix Applied
Both `setParallelAgents` calls now update `parallelAgentsRef.current` inside the updater function:

**spawnSubagent() fix (chat.tsx ~line 2886):**
```typescript
setParallelAgents((prev) => {
  const next = [...prev, parallelAgent];
  parallelAgentsRef.current = next;
  return next;
});
```

**onStatusUpdate fix (chat.tsx ~line 2304):**
```typescript
onStatusUpdate: (agentId, update) => {
  setParallelAgents((prev) => {
    const next = prev.map((a) => (a.id === agentId ? { ...a, ...update } : a));
    parallelAgentsRef.current = next;
    return next;
  });
},
```

### Tests Added
3 new tests in `src/ui/__tests__/spawn-subagent-integration.test.ts`:
- "spawnSubagent path: ref syncs when adding agent"
- "onStatusUpdate path: ref syncs when updating agent status"
- "ref desync prevented: handleComplete defers correctly with active agents"

All 10 tests pass (7 existing + 3 new).

## Task #4: Update SubagentGraphBridge to propagate status callbacks (COMPLETED)

### Date: 2025-07-23

### Problem
`setSubagentBridge()` was NEVER called in the codebase. The `SubagentGraphBridge` singleton was always null,
so `subagentNode()` and `parallelSubagentNode()` in nodes.ts always threw errors. Graph-based workflows
could never spawn sub-agents.

### Fix Applied
1. **chat.tsx**: After creating `SubagentSessionManager`, now also creates a `SubagentGraphBridge`
   wrapping the manager and calls `setSubagentBridge(bridge)`. On cleanup, calls `setSubagentBridge(null)`.
2. **subagent-bridge.ts**: Updated `setSubagentBridge()` signature to accept `SubagentGraphBridge | null`
   for proper cleanup.

### Files Modified
- `src/ui/chat.tsx`: Added import of `SubagentGraphBridge` and `setSubagentBridge`, added bridge init
  in SubagentSessionManager useEffect
- `src/graph/subagent-bridge.ts`: Changed `setSubagentBridge` parameter type to accept null

### Tests Added
2 new tests in `src/ui/__tests__/spawn-subagent-integration.test.ts`:
- "bridge wraps session manager and delegates spawn()"
- "setSubagentBridge(null) clears the global bridge"

All 12 tests pass (10 existing + 2 new).

## Task #5: OpenCode TUI Empty File Fix and UI Consistency (COMPLETED)

### Date: 2026-02-12

### Summary
The implementation for enhanced output extraction was already present in `src/ui/tools/registry.ts`. Added comprehensive test coverage for all SDK format variations.

### What Was Already Implemented
The extraction logic in `readToolRenderer.render()` already handled:
- `parsed.file.content`, `parsed.content`, `parsed` (string), `parsed.text`, `parsed.value`, `parsed.data` for string outputs
- `output.file.content`, `output.output`, `output.content`, `output.text`, `output.value`, `output.data`, `output.result` for object outputs
- Empty file vs extraction failure differentiation
- Debug info for extraction failures

### Changes Made
1. Removed unused `extractionFailed` variable in `src/ui/tools/registry.ts`
2. Added 11 new test cases in `tests/ui/tools/registry.test.ts`:
   - "render handles OpenCode direct string output"
   - "render handles OpenCode { output: string } without metadata"
   - "render handles output.text field"
   - "render handles output.value field"
   - "render handles output.data field"
   - "render handles Copilot result field"
   - "render differentiates empty file from extraction failure"
   - "render shows extraction failure for unknown format"
   - "render handles undefined output"
   - "render handles null output"

### Test Results
- All 65 tests pass (54 existing + 11 new)
- Lint passes with only pre-existing warnings unrelated to changes

## Task #6: Verbose Mode and Footer Status Implementation (IN PROGRESS)

### Date: 2026-02-12

### Summary
Implementation of verbose mode toggle functionality and footer status display for the TUI.

### Completed Tasks

**Task #1: Create useVerboseMode hook**
- Created `src/ui/hooks/use-verbose-mode.ts`
- Hook manages verbose mode state with `toggle`, `setVerboseMode`, `enable`, `disable` functions
- Exported from `src/ui/hooks/index.ts`
- All verbose mode tests pass (127 tests)

**Task #2: Create spinner verbs constants**
- Created `src/ui/constants/spinner-verbs.ts`
- Exported `SPINNER_VERBS`, `COMPLETION_VERBS`, `getRandomVerb`, `getRandomCompletionVerb`
- Created `src/ui/constants/index.ts` for module exports

**Task #3: Add TypeScript types**
- Created `src/ui/types.ts`
- Added `FooterState`, `FooterStatusProps`, `VerboseProps`, `TimestampProps`, `DurationProps`, `ModelProps`, `EnhancedMessageMeta`
- Re-exported `PermissionMode` from SDK types

**Task #4: Create FooterStatus component**
- Created `src/ui/components/footer-status.tsx`
- Displays: modelId, streaming status, verbose mode, queued count, permission mode
- Includes Ctrl+O hint for toggling verbose mode
- Exported from `src/ui/components/index.ts`

**Task #7: Enhance LoadingIndicator with spinner verbs**
- Updated `src/ui/chat.tsx` to import spinner verbs from constants
- Removed inline `SPINNER_VERBS` and `COMPLETION_VERBS`
- Re-exported for backward compatibility

**Task #8: Add formatTimestamp and formatDuration utilities**
- Already existed in `src/ui/utils/format.ts`

**Task #11: Fix Copilot subagent.failed mapping**
- Changed mapping from `"subagent.failed": "session.error"` to `"subagent.failed": "subagent.complete"`
- Updated event data to include `subagentId` and `success: false`
- Updated test to reflect new mapping
- All 14 subagent event mapping tests pass

### Files Created
- `src/ui/hooks/use-verbose-mode.ts`
- `src/ui/constants/spinner-verbs.ts`
- `src/ui/constants/index.ts`
- `src/ui/types.ts`
- `src/ui/components/footer-status.tsx`

### Files Modified
- `src/ui/hooks/index.ts` - Added useVerboseMode exports
- `src/ui/components/index.ts` - Added FooterStatus exports
- `src/ui/chat.tsx` - Updated spinner verb imports, added re-exports
- `src/sdk/copilot-client.ts` - Fixed subagent.failed mapping
- `src/sdk/__tests__/subagent-event-mapping.test.ts` - Updated test for new mapping

### Remaining Tasks (High Priority)
- Task #5: Enhance ToolResult component with verbose, timestamp, model, durationMs props
- Task #6: Enhance ParallelAgentsTree component with isVerbose prop
- Task #9: Integrate verbose mode and footer into src/ui/chat.tsx
- Task #10: Wire Ctrl+O keyboard handler for global verbose toggle
