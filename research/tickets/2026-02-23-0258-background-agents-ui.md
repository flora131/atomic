---
date: 2026-02-23 02:06:44 UTC
researcher: OpenCode
git_commit: f674c962807d5926f0f19633e66192e7d8ce1039
branch: fix/tui-streaming-rendering
repository: fix-tui-streaming-rendering
topic: "#258 — Background agents UI (footer status bar, Ctrl+F termination flow, tree hints)"
tags: [research, codebase, tui, background-agents, issue-258, keyboard]
status: complete
last_updated: 2026-02-23
last_updated_by: OpenCode
---

# Research

## Research Question
Thoroughly research GitHub issue `#258` (Background agents UI), extract all issue data and images with `gh`, and map current codebase behavior for:
- Footer status bar behavior for background agents
- Ctrl+F termination flow (including confirmation)
- Tree view hint text (including Ctrl+O wording)
- Scope across dev and production paths

## Summary
Issue `#258` describes missing background-agent UI features, but this repository state already contains concrete implementations for background footer rendering, Ctrl+F double-press termination, confirmation text, and tree hint text generation.

At this commit, the actively mounted footer path is `BackgroundAgentFooter` (not `FooterStatus`), Ctrl+F behavior is implemented through utility-driven decision/interrupt helpers and a parent callback bridge, and tree header hints are generated by a dedicated hint utility with explicit background-aware strings.

The same `ChatApp` and UI modules are used by both dev (`bun run src/cli.ts`) and production (`bun build src/cli.ts --compile --outfile atomic`) entry paths, so behavior is shared across both runtime modes.

## Detailed Findings

### GitHub issue extraction and assets
- Issue metadata, timeline events, referenced commit, and screenshot URLs were extracted via `gh`; full extraction is documented in `research/docs/2026-02-23-gh-issue-258-background-agents-ui.md`.
- Issue URL: `https://github.com/flora131/atomic/issues/258`.
- Timeline includes a `referenced` event pointing to commit `92b9badb08a9b3d0a3243cd4ec8c140c190d2744` (adds `research/branch-tasks.md`).

### Footer status implementation surfaces
- `FooterStatus` exists as a general status component with verbose/queue/model/permission formatting and a Ctrl+O hint (`src/ui/components/footer-status.tsx:99`, `src/ui/components/footer-status.tsx:156`).
- `FooterStatus` types and exports exist (`src/ui/types.ts:27`, `src/ui/types.ts:45`, `src/ui/components/index.ts:130`).
- `ChatApp` currently mounts `BackgroundAgentFooter` at the bottom of the root layout (`src/ui/chat.tsx:30`, `src/ui/chat.tsx:5914`).
- `BackgroundAgentFooter` renders label text and appends `ctrl+f terminate` hint (`src/ui/components/background-agent-footer.tsx:16`, `src/ui/components/background-agent-footer.tsx:31`, `src/ui/components/background-agent-footer.tsx:32`).
- Footer agent selection resolves from live agents first, then message snapshots (`src/ui/utils/background-agent-footer.ts:24`, `src/ui/utils/background-agent-footer.ts:28`, `src/ui/utils/background-agent-footer.ts:33`).

### Ctrl+F termination flow (double-press + confirmation)
- Ctrl+F key detection is centralized in `isBackgroundTerminationKey` (`src/ui/utils/background-agent-termination.ts:22`).
- Decision logic for first-press warning and second-press terminate is in `getBackgroundTerminationDecision` (`src/ui/utils/background-agent-termination.ts:29`).
- Interruption transformation of active background agents is in `interruptActiveBackgroundAgents` (`src/ui/utils/background-agent-termination.ts:57`).
- `ChatApp` keyboard handler applies this flow in the Ctrl+F branch (`src/ui/chat.tsx:4380`, `src/ui/chat.tsx:4388`, `src/ui/chat.tsx:4401`).
- First press sets confirmation state and timer (`src/ui/chat.tsx:4434`, `src/ui/chat.tsx:4439`), and warning text is rendered in UI (`src/ui/chat.tsx:5903`, `src/ui/chat.tsx:5906`).
- Second press updates message-level parallel-agent snapshot, prunes live background agents, calls parent termination callback, and appends chat confirmation `All background agents killed` (`src/ui/chat.tsx:4411`, `src/ui/chat.tsx:4423`, `src/ui/chat.tsx:4429`, `src/ui/chat.tsx:4430`).
- Parent callback in UI integration resets stream/run state and aborts session if supported (`src/ui/index.ts:1809`, `src/ui/index.ts:1814`, `src/ui/index.ts:1823`).

### Tree view hint generation and Ctrl+O relationship
- Tree header hints are generated by `buildParallelAgentsHeaderHint` (`src/ui/utils/background-agent-tree-hints.ts:22`).
- Hint strings include:
  - `background running · ctrl+f terminate` (`src/ui/utils/background-agent-tree-hints.ts:29`)
  - `background complete · ctrl+o to expand` (`src/ui/utils/background-agent-tree-hints.ts:33`)
  - `ctrl+o to expand` (`src/ui/utils/background-agent-tree-hints.ts:37`)
- `ParallelAgentsTree` renders this hint next to header text (`src/ui/components/parallel-agents-tree.tsx:550`, `src/ui/components/parallel-agents-tree.tsx:562`).
- Ctrl+O keyboard behavior toggles transcript mode globally (`src/ui/chat.tsx:4448`, `src/ui/chat.tsx:4449`), switching to `<TranscriptView>` (`src/ui/chat.tsx:5712`, `src/ui/components/transcript-view.tsx:73`).
- Transcript footer line includes `ctrl+o to toggle` (`src/ui/utils/transcript-formatter.ts:249`).

### Background agent lifecycle integration
- Agent status type includes `background` and `interrupted` (`src/ui/components/parallel-agents-tree.tsx:27`).
- Tool-complete finalization guard excludes background agents (`src/ui/parts/guards.ts:19`, `src/ui/parts/guards.ts:20`, `src/ui/parts/guards.ts:21`).
- Foreground-only deferred-finalization gate is used to avoid blocking on background agents (`src/ui/parts/guards.ts:29`, `src/ui/parts/guards.ts:40`, `src/ui/chat.tsx:3479`, `src/ui/chat.tsx:5204`).
- Background agents are baked into message parts via `parallel-agents` stream events and `mergeParallelAgentsIntoParts` (`src/ui/parts/stream-pipeline.ts:863`, `src/ui/parts/stream-pipeline.ts:637`, `src/ui/chat.tsx:2737`).
- Agent tree rendering in message parts is mounted by registry and `AgentPartDisplay` (`src/ui/components/parts/registry.tsx:26`, `src/ui/components/parts/agent-part-display.tsx:24`).

### Dev and production path coverage
- Dev entry script: `bun run src/cli.ts` (`package.json:33`).
- Production compile target: `bun build src/cli.ts --compile --outfile atomic` (`package.json:34`).
- CLI default `chat` command routes into `chatCommand` then `startChatUI` (`src/cli.ts:94`, `src/cli.ts:144`, `src/commands/chat.ts:196`, `src/commands/chat.ts:283`).
- `ChatApp` and the same UI/keyboard/background modules are used in that shared path (`src/ui/index.ts:1901`, `src/ui/chat.tsx:1636`).

### Test coverage related to this issue area
- Background footer helpers: active detection, snapshot fallback, label formatting (`src/ui/utils/background-agent-footer.test.ts:20`).
- Background termination helpers: Ctrl+F key detection, double-press decisions, interrupt transformation (`src/ui/utils/background-agent-termination.test.ts:23`, `src/ui/utils/background-agent-termination.test.ts:60`).
- Tree hint strings: active/complete/default hint variants (`src/ui/utils/background-agent-tree-hints.test.ts:4`).
- Lifecycle guards and background persistence behavior: `shouldFinalizeOnToolComplete` and mixed state transitions (`src/ui/parallel-agent-background-lifecycle.test.ts:155`, `src/ui/parts/background-agent-e2e.test.ts:44`).

## Code References
- `src/ui/chat.tsx:30` - `BackgroundAgentFooter` import in chat UI.
- `src/ui/chat.tsx:4380` - Ctrl+F keyboard branch.
- `src/ui/chat.tsx:4401` - Background-agent interruption call.
- `src/ui/chat.tsx:4430` - Chat confirmation message for killed background agents.
- `src/ui/chat.tsx:4448` - Ctrl+O transcript toggle handling.
- `src/ui/chat.tsx:5619` - Footer agent resolution from live + message state.
- `src/ui/chat.tsx:5914` - Footer mount location.
- `src/ui/components/background-agent-footer.tsx:12` - Footer component implementation.
- `src/ui/components/footer-status.tsx:99` - FooterStatus component implementation.
- `src/ui/utils/background-agent-footer.ts:24` - Footer agent resolver.
- `src/ui/utils/background-agent-termination.ts:29` - Double-press decision helper.
- `src/ui/utils/background-agent-tree-hints.ts:22` - Tree header hint builder.
- `src/ui/components/parallel-agents-tree.tsx:550` - Tree header hint assignment.
- `src/ui/index.ts:1809` - Parent callback for background termination.
- `src/ui/parts/guards.ts:19` - Guard excluding background from tool-complete finalization.
- `src/ui/parts/stream-pipeline.ts:637` - Parallel-agent merge into message parts.
- `package.json:33` - Dev command entry.
- `package.json:34` - Production compile entry.
- `src/commands/chat.ts:283` - `startChatUI` invocation.

## Architecture Documentation
- Keyboard input is centralized in a single `useKeyboard` callback and branches by shortcut before rendering updates (`src/ui/chat.tsx:4140`).
- Background termination behavior is split between UI decision/mutation logic (`src/ui/chat.tsx`) and parent session abort/reset integration (`src/ui/index.ts`).
- Footer background-agent display is driven by a resolver utility that prefers live process state and falls back to message snapshots.
- Parallel-agent visualization is parts-driven: stream events update message parts, and part renderers mount `ParallelAgentsTree`.
- Transcript mode (`Ctrl+O`) is a global display toggle between scrollbox chat view and transcript view, with shared message/history sources.

## Historical Context (from research/)
- `research/branch-tasks.md` - Branch grouping note explicitly lists issue `#258` and states Dev + Production impact (`research/branch-tasks.md:12`, `research/branch-tasks.md:13`).
- `research/docs/2026-02-16-sub-agent-tree-inline-state-lifecycle-research.md` - Prior research documented lifecycle and background-status handling context for sub-agent trees.
- `research/docs/2026-02-17-message-truncation-dual-view-system.md` - Prior research documented Ctrl+O transcript dual-view behavior.
- `research/docs/2026-02-21-workflow-sdk-inline-mode-research.md` - Prior research documented interrupt/control-flow behavior around streaming and workflow sessions.
- `research/docs/2026-02-01-claude-code-ui-patterns-for-atomic.md` - Earlier UI pattern capture for footer/hint language references.

## Related Research
- `research/docs/2026-02-23-gh-issue-258-background-agents-ui.md`
- `research/docs/2026-02-16-sub-agent-tree-inline-state-lifecycle-research.md`
- `research/docs/2026-02-17-message-truncation-dual-view-system.md`
- `research/docs/2026-02-21-workflow-sdk-inline-mode-research.md`
- `research/docs/2026-02-01-claude-code-ui-patterns-for-atomic.md`

## Open Questions
- The issue text claims several features are absent, while this code snapshot includes implementations for these surfaces; branch/revision alignment between issue report and runtime observation is not encoded in issue metadata.
- `FooterStatus` exists and is exported, while runtime footer rendering is performed by `BackgroundAgentFooter`; the issue body references `FooterStatus` explicitly.
- Current branch is `fix/tui-streaming-rendering` and local status is `ahead 1`; repository file references in this document therefore use local paths instead of commit permalinks.
